Name: Check Changes

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      changed: ${{ steps.commit_check.outputs.changed }}
      jp_up: ${{ steps.status.outputs.jp_up }}
      gl_up: ${{ steps.status.outputs.gl_up }}
      cn_up: ${{ steps.status.outputs.cn_up }}
      jp_v: ${{ steps.final_ver.outputs.jp_v }}
      gl_v: ${{ steps.final_ver.outputs.gl_v }}
      cn_v: ${{ steps.final_ver.outputs.cn_v }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.APK_SRC_REPO }}

      - name: Clone repositories
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git temp_src
          cp -r temp_src/* .
          rm -rf temp_src

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install requirements
        run: pip install -r requirements.txt

      - name: Update Data
        id: update_step
        env: 
          PYTHONUNBUFFERED: "1"
          JP_APK_CACHE_PATH: /tmp/BlueArchive_JP.xapk
          GL_APK_CACHE_PATH: /tmp/BlueArchive_GL.xapk
          CN_APK_CACHE_PATH: /tmp/BlueArchive_CN.apk
        run: python update_url.py info.json

      - name: Get Final Versions
        id: final_ver
        run: |
          JP_V=$(jq -r '.JP.Version' info.json)
          GL_V=$(jq -r '.GL.Version' info.json)
          CN_V=$(jq -r '.CN.Version' info.json)
          echo "jp_v=$JP_V" >> $GITHUB_OUTPUT
          echo "gl_v=$GL_V" >> $GITHUB_OUTPUT
          echo "cn_v=$CN_V" >> $GITHUB_OUTPUT

      - name: Determine Cache Paths
        id: cache_paths
        run: |
          PATHS=""
          [ -f /tmp/BlueArchive_JP.xapk ] && PATHS+="/tmp/BlueArchive_JP.xapk"$'\n'
          [ -f /tmp/BlueArchive_GL.xapk ] && PATHS+="/tmp/BlueArchive_GL.xapk"$'\n'
          [ -f /tmp/BlueArchive_CN.apk ] && PATHS+="/tmp/BlueArchive_CN.apk"
          echo "paths<<EOF" >> $GITHUB_OUTPUT
          echo "$PATHS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Save APK Caches
        if: steps.cache_paths.outputs.paths != ''
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.cache_paths.outputs.paths }}
          key: APK-CACHE-${{ steps.final_ver.outputs.jp_v }}-${{ steps.final_ver.outputs.gl_v }}-${{ steps.final_ver.outputs.cn_v }}

      - name: Commit Changes
        id: commit_check
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          curl -sS -f https://prod-noticeindex.bluearchiveyostar.com/prod/index.json | jq . > index.json
          git add info.json index.json
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update: $(date -d "+8 hours" "+%Y-%m-%d %H:%M:%S")"
            git push origin HEAD
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Status and Dispatch
        id: status
        if: steps.commit_check.outputs.changed == 'true'
        run: |
          JP_UP=$([ -n "${{ steps.update_step.outputs.jp_apk_path }}" ] && echo "true" || echo "false")
          GL_UP=$(git diff HEAD^ HEAD info.json | grep -q '"GL"' && echo "true" || echo "false")
          CN_UP=$(git diff HEAD^ HEAD info.json | grep -q '"CN"' && echo "true" || echo "false")
          echo "jp_up=$JP_UP" >> $GITHUB_OUTPUT
          echo "gl_up=$GL_UP" >> $GITHUB_OUTPUT
          echo "cn_up=$CN_UP" >> $GITHUB_OUTPUT
          if ! git diff HEAD^ HEAD index.json --quiet; then
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${{ github.repository }}/dispatches -d '{"event_type": "Notic"}'
          fi

      - name: Generate Strategy Matrix
        id: set-matrix
        if: steps.commit_check.outputs.changed == 'true'
        run: |
          MATRIX=$(jq -nc --arg jp "${{ steps.status.outputs.jp_up }}" --arg gl "${{ steps.status.outputs.gl_up }}" --arg cn "${{ steps.status.outputs.cn_up }}" \
            '[
              {id: "JP", name: "日服", enabled: $jp},
              {id: "GL", name: "国际服", enabled: $gl},
              {id: "CN", name: "国服", enabled: $cn}
            ] | map(select(.enabled == "true"))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  setup_flatdata:
    needs: check_changes
    if: needs.check_changes.outputs.changed == 'true' && needs.check_changes.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        server: ${{ fromJson(needs.check_changes.outputs.matrix) }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Clone Tool
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev
          pip install pysqlcipher3 sqlcipher3 -r requirements.txt
      - name: Get Version
        id: v
        run: |
          if [ "${{ matrix.server.id }}" == "JP" ]; then echo "fl_ver=${{ needs.check_changes.outputs.jp_v }}" >> $GITHUB_OUTPUT; fi
          if [ "${{ matrix.server.id }}" == "GL" ]; then echo "fl_ver=${{ needs.check_changes.outputs.gl_v }}" >> $GITHUB_OUTPUT; fi
          if [ "${{ matrix.server.id }}" == "CN" ]; then echo "fl_ver=${{ needs.check_changes.outputs.cn_v }}" >> $GITHUB_OUTPUT; fi
      - name: Restore APK Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /tmp/BlueArchive_JP.xapk
            /tmp/BlueArchive_GL.xapk
            /tmp/BlueArchive_CN.apk
          key: APK-CACHE-${{ needs.check_changes.outputs.jp_v }}-${{ needs.check_changes.outputs.gl_v }}-${{ needs.check_changes.outputs.cn_v }}
          restore-keys: APK-CACHE-
      - name: Run Setup
        env:
          JP_APK_CACHE_PATH: /tmp/BlueArchive_JP.xapk
          GL_APK_CACHE_PATH: /tmp/BlueArchive_GL.xapk
          CN_APK_CACHE_PATH: /tmp/BlueArchive_CN.apk
        run: python setup_flatdata.py ${{ matrix.server.id }}
      - name: Save FlatData
        uses: actions/cache/save@v4
        with:
          path: ./Extracted
          key: ${{ matrix.server.id }}${{ steps.v.outputs.fl_ver }}
      - name: Package and Push
        env:
          GH_TOKEN: ${{ secrets.APK_SRC_REPO }}
        run: |
          ZIP_NAME="${{ matrix.server.name }}${{ steps.v.outputs.fl_ver }}.zip"
          cd Extracted && zip -r "../$ZIP_NAME" . && cd ..
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone --depth 1 --branch ${{ matrix.server.id }} https://x-access-token:${GH_TOKEN}@github.com/beichen23333/BA-FlatData.git repo_flat
          cp "$ZIP_NAME" repo_flat/
          cd repo_flat && git add . && git commit -m "Upload FlatData: $ZIP_NAME" && git push origin ${{ matrix.server.id }} || echo "No changes"

  dispatch_unpack:
    needs: [check_changes, setup_flatdata]
    runs-on: ubuntu-latest
    if: always() && needs.check_changes.outputs.changed == 'true'
    steps:
      - name: Dispatch Unpack
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\": \"Unpack\", \"client_payload\": {\"JP_enabled\": ${{ needs.check_changes.outputs.jp_up }}, \"GL_enabled\": ${{ needs.check_changes.outputs.gl_up }}, \"CN_enabled\": ${{ needs.check_changes.outputs.cn_up }}}}"
