name: Check Update

concurrency:
  group: check-update
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check:
    name: 检查
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
      cn_changes: ${{ steps.run_script.outputs.cn_table_changed }}
      gl_changes: ${{ steps.run_script.outputs.gl_catalog_changed }}
      jp_changes: ${{ steps.run_script.outputs.jp_catalog_changed }}
      jp_server_info_name: ${{ steps.run_script.outputs.jp_server_info_name }}
      jp_addressable_name: ${{ steps.run_script.outputs.jp_addressable_name }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Prepare Tool Environment
        run: |
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Continuous Execute Commit and Check
        id: run_script
        env:
          PYTHONUNBUFFERED: "1"
          GH_TOKEN: ${{ secrets.APK_SRC_REPO }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # GitHub的延迟最低15分钟，可能无法及时更新，因此这里运用循环，循环6小时检查（极限运行时长），解决GitHub延迟问题
          while true; do
            : > "$GITHUB_OUTPUT"

            python update_url.py

            git add info_jp.json info_gl.json info_cn.json info_jp_windows.json
            if ! git diff --staged --quiet; then
              git commit -m "Update"
              git push
              break
            fi

            JP_CATALOG_CHANGED=$(grep '^jp_catalog_changed=' "$GITHUB_OUTPUT" | cut -d= -f2)

            if [ "$JP_CATALOG_CHANGED" = "false" ]; then
              CATALOG_URL=$(jq -r '.AddressableCatalogUrl' info_jp.json)
              TARGET_URL="${CATALOG_URL}/TableBundles/TableCatalog.bytes"

              HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$TARGET_URL")
              if [ "$HTTP_STATUS" = "200" ]; then
                for WF in UpdateUnpack.yml UpdateRepack.yml UpdateBundles.yml; do
                  RUN=$(gh run list --workflow "$WF" --limit 1 --json databaseId,conclusion --jq '.[0]')
                  ID=$(echo "$RUN" | jq -r '.databaseId')
                  STATUS=$(echo "$RUN" | jq -r '.conclusion')

                  if [ "$STATUS" = "failure" ] && [ -n "$ID" ]; then
                    gh api repos/${{ github.repository }}/actions/runs/$ID/rerun -X POST
                  fi
                done
              fi
            fi

            sleep 30
          done

      - name: Run APK
        if: steps.run_script.outputs.jp_version_changed == 'true'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.APK_SRC_REPO }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/bluearchive-cafe/BAJpApkSrc/dispatches \
            -d '{"event_type": "APK"}'

      - name: Generate Matrix Output
        id: set-matrix
        run: |
          MATRIX_JSON='{"include":[]}'
          HAS_CHANGES="false"

          if [ "${{ steps.run_script.outputs.jp_version_changed }}" == "true" ]; then
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c '.include += [{"id": "JP", "name": "日服", "version": "${{ steps.run_script.outputs.jp_version }}"}]')
            HAS_CHANGES="true"
          fi
          if [ "${{ steps.run_script.outputs.gl_version_changed }}" == "true" ]; then
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c '.include += [{"id": "GL", "name": "国际服", "version": "${{ steps.run_script.outputs.gl_version }}"}]')
            HAS_CHANGES="true"
          fi
          if [ "${{ steps.run_script.outputs.cn_version_changed }}" == "true" ]; then
            MATRIX_JSON=$(echo $MATRIX_JSON | jq -c '.include += [{"id": "CN", "name": "国服", "version": "${{ steps.run_script.outputs.cn_version }}"}]')
            HAS_CHANGES="true"
          fi
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

  FlatData:
    name: 处理${{ matrix.name }}
    needs: check
    if: needs.check.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.check.outputs.matrix) }}
      fail-fast: false    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache FlatData
        id: cache-flatdata
        uses: actions/cache@v4
        with:
          path: Extracted
          key: ${{ matrix.id }}-flatdata-${{ matrix.version }}

      - name: Prepare Tool Environment
        run: |
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool
          pip install -r requirements.txt

      - name: Clone FlatData Branch
        run: |
          git clone --depth 1 --branch ${{ matrix.id }} git@github.com:bluearchive-cafe/BA-FlatData.git repo_data

      - name: Copy CN Dump File
        if: matrix.id == 'CN'
        run: |
          mkdir -p Dumps
          if [ -f "repo_data/dump.cs" ]; then
            cp repo_data/dump.cs Dumps/dump.cs
            echo "Successfully copied dump.cs for CN server."
          else
            echo "Warning: dump.cs not found in repo_data."
          fi

      - name: Setup FlatData
        if: steps.cache-flatdata.outputs.cache-hit != 'true'
        run: python setup_flatdata.py ${{ matrix.id }}

      - name: Create Zip and Move
        run: |
          ZIP_NAME="${{ matrix.name }}${{ matrix.version }}.zip"
          cd Extracted && zip -r "../$ZIP_NAME" . && cd ..
          mv "$ZIP_NAME" repo_data/

      - name: Commit and Push to FlatData
        run: |
          cd repo_data
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Upload Data: ${{ matrix.name }} ${{ matrix.version }}" --allow-empty
          git push origin ${{ matrix.id }}

  Final:
    name: 部署
    needs: [check, FlatData]
    if: |
      always() && 
      needs.check.result == 'success' &&
      (needs.FlatData.result == 'success' || needs.FlatData.result == 'skipped') &&
      (needs.check.outputs.cn_changes == 'true' || needs.check.outputs.jp_changes == 'true' || needs.check.outputs.gl_changes == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Run Unpack
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.APK_SRC_REPO }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "Unpack","client_payload": {"JP_Enabled": "${{ needs.check.outputs.jp_changes }}", "GL_Enabled": "${{ needs.check.outputs.gl_changes }}", "CN_Enabled": "${{ needs.check.outputs.cn_changes }}"}}'

      - name: Run Repack
        if: needs.check.outputs.jp_changes == 'true'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.APK_SRC_REPO }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "Text","client_payload": {"custom_dir": "${{ needs.check.outputs.jp_addressable_name }}"}}'

      - name: Run Bundles
        if: needs.check.outputs.jp_changes == 'true'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.APK_SRC_REPO }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "Bundles","client_payload": {"custom_dir": "${{ needs.check.outputs.jp_addressable_name }}"}}'
