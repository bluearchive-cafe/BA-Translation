name: Update Unpack Table & Media

on:
  workflow_dispatch:
    inputs:
      Unpack_FlatData:
        description: 'Unpack FlatData?'
        required: false
        type: boolean
        default: true
      Downloads_Media:
        description: 'Downloads Media?'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [run-deployment]

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-versions.outputs.BA_VERSION_NAME }}
      trigger-type: ${{ steps.detect-trigger.outputs.trigger-type }}
      unpack-flatdata: ${{ steps.detect-params.outputs.unpack-flatdata }}
      downloads-media: ${{ steps.detect-params.outputs.downloads-media }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Detect trigger type
        id: detect-trigger
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "trigger-type=repository_dispatch" >> $GITHUB_OUTPUT
          else
            echo "trigger-type=workflow_dispatch" >> $GITHUB_OUTPUT
          fi

      - name: Detect trigger parameters
        id: detect-params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            UNPACK_FLATDATA="${{ github.event.client_payload.unpack_flatdata || 'true' }}"
            DOWNLOADS_MEDIA="${{ github.event.client_payload.downloads_media || 'false' }}"
            echo "unpack-flatdata=$UNPACK_FLATDATA" >> $GITHUB_OUTPUT
            echo "downloads-media=$DOWNLOADS_MEDIA" >> $GITHUB_OUTPUT
          else
            echo "unpack-flatdata=${{ inputs.Unpack_FlatData || 'true' }}" >> $GITHUB_OUTPUT
            echo "downloads-media=${{ inputs.Downloads_Media || 'false' }}" >> $GITHUB_OUTPUT
          fi

      - name: Debug trigger info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Client payload: ${{ toJSON(github.event.client_payload) }}"
          echo "Inputs: ${{ toJSON(github.event.inputs) }}"
          echo "Detected parameters:"
          echo "  unpack-flatdata: ${{ steps.detect-params.outputs.unpack-flatdata }}"
          echo "  downloads-media: ${{ steps.detect-params.outputs.downloads-media }}"

      - name: Get version
        id: get-versions
        run: bash version.sh info.json >> "$GITHUB_OUTPUT"

      - name: Get version name
        run: |
          echo "BA_VERSION_NAME=${{ steps.get-versions.outputs.BA_VERSION_NAME }}" >> $GITHUB_ENV

  table:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.unpack-flatdata == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone BA-FlatData
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git

      - name: Clone BA-Text
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Text.git

      - name: Setup FlatData
        run: |
          python setup_flatdata.py

      - name: Downloads Table files and run MemoryPackRepacker
        run: |
          chmod +x update.sh
          ./update.sh JP Table

      - name: Unpack ExcelDB.db and Excel.zip
        run: |
          python unpack_excel.py ./downloads/TableBundles/ExcelDB.db ./downloads/TableBundles/Excel.zip ./unpacked ./Extracted/FlatData config.json BA-Text 10

      - name: Prepare FlatData
        run: |
          cd ./Extracted/FlatData/
          zip -j "FlatData${BA_VERSION_NAME}.zip" *
          mv "FlatData${BA_VERSION_NAME}.zip" ../../BA-FlatData/
          cd

      - name: Prepare Text files
        run: |
          cp {TableCatalog.json,MediaCatalog.json,BundlePackingInfo-iOS.json,BundlePackingInfo-Android.json} BA-Text
          cd BA-Text
          zip -r "./日服${BA_VERSION_NAME}.zip" DBSchema ExcelTable
          cd

      - name: Prepare Assets files
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git
          FILES=("TableCatalog.json" "MediaCatalog.json" "BundlePackingInfo-iOS.json" "BundlePackingInfo-Android.json")

          for file in "${FILES[@]}"; do
            if [ -f "BA-Assets/$file" ]; then
              rm "BA-Assets/$file"
            fi
          done

          cp {TableCatalog.json,MediaCatalog.json,BundlePackingInfo-iOS.json,BundlePackingInfo-Android.json} "BA-Assets"
          if [ -d "BA-Assets/DBSchema" ]; then
            rm -rf "BA-Assets/DBSchema"
          fi
          mv "BA-Text/DBSchema" "BA-Assets/DBSchema"
          if [ -d "BA-Assets/ExcelTable" ]; then
            rm -rf "BA-Assets/ExcelTable"
          fi
          mv "BA-Text/ExcelTable" "BA-Assets/ExcelTable"

          cd BA-Assets

          for item in DBSchema ExcelTable TableCatalog.json MediaCatalog.json BundlePackingInfo-iOS.json BundlePackingInfo-Android.json; do
              if [ -e "$item" ]; then
                  if [ -d "$item" ]; then
                      find "$item" -type f | while read -r file; do
                          file_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
                          if [ "$file_size" -gt 104857600 ]; then
                              gzip -c "$file" > "$file.gz"
                              rm "$file"
                          fi
                      done
                  else
                      file_size=$(stat -c%s "$item" 2>/dev/null || stat -f%z "$item")
                      if [ "$file_size" -gt 104857600 ]; then
                          gzip -c "$item" > "$item.gz"
                          rm "$item"
                      fi
                  fi
              fi
          done

      - name: Upload Table artifacts
        uses: actions/upload-artifact@v4
        with:
          name: table-changes
          path: |
            BA-FlatData/
            BA-Text/
            BA-Assets/
          retention-days: 1

  media:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.downloads-media == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Downloads Media files
        run: |
          chmod +x update.sh
          ./update.sh JP Media 8

      - name: Create media zip package
        run: |
          if [ -d "./media_temp" ] && [ "$(ls -A ./media_temp 2>/dev/null)" ]; then
            cd ./media_temp
            zip -r "../media_extracted_content.zip" .
            cd
          else
            touch empty_media.zip
          fi

      - name: Upload Media zip artifacts
        uses: actions/upload-artifact@v4
        with:
          name: media-zip
          path: |
            media_extracted_content.zip
            empty_media.zip
          retention-days: 1

  final-commit:
    runs-on: ubuntu-latest
    needs: [setup, table, media]
    if: always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped'))
    env:
      BA_VERSION_NAME: ${{ needs.setup.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone BA-Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Download Table artifacts
        if: needs.table.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: table-changes
          path: artifacts/table-changes
          retry-count: 5
          retry-delay: 30000

      - name: Download Media zip artifacts
        if: needs.media.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: media-zip
          path: artifacts/media-zip
          retry-count: 5
          retry-delay: 30000

      - name: Extract and merge all artifacts to BA-Assets
        run: |
          if [ -d "artifacts/table-changes" ] && [ "$(ls -A artifacts/table-changes 2>/dev/null)" ]; then
            if [ -d "artifacts/table-changes/BA-Assets" ]; then
              rsync -av artifacts/table-changes/BA-Assets/ BA-Assets/ || true
            fi
          fi
          
          if [ -f "artifacts/media-zip/media_extracted_content.zip" ]; then
            unzip -q -o artifacts/media-zip/media_extracted_content.zip -d BA-Assets/
          elif [ -f "artifacts/media-zip/empty_media.zip" ]; then
            echo "没有Media内容可合并"
          fi

      - name: Configure git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Set version in environment
        run: |
          echo "BA_VERSION_NAME=$BA_VERSION_NAME"

      - name: Smart commit to BA-Assets
        if: needs.table.result == 'success' || needs.media.result == 'success'
        run: |
          cd BA-Assets
          
          find . -name "*.mp4" -type f | head -1000 | while read file; do
            git add "$file"
          done
          if ! git diff --staged --quiet; then
            git commit -m "Update Assets: mp4 files - version ${{ needs.setup.outputs.version }}"
          fi
  
          find . -name "*.jpg" -type f | head -1000 | while read file; do
            git add "$file"
          done
          if ! git diff --staged --quiet; then
            git commit -m "Update Assets: jpg files - version ${{ needs.setup.outputs.version }}"
          done

          find . -name "*.ogg" -type f | head -1000 | while read file; do
            git add "$file"
          done
          if ! git diff --staged --quiet; then
            git commit -m "Update Assets: ogg files - version ${{ needs.setup.outputs.version }}"
          fi
          
          find . -name "*.json" -type f | head -1000 | while read file; do
            git add "$file"
          done
          if ! git diff --staged --quiet; then
            git commit -m "Update Assets: json files - version ${{ needs.setup.outputs.version }}"
          fi
          
          find . -name "*.zip" -type f | head -1000 | while read file; do
            git add "$file"
          done
          if ! git diff --staged --quiet; then
            git commit -m "Update Assets: zip files - version ${{ needs.setup.outputs.version }}"
          fi
          
          batch_num=1
          find . -type f | grep -vE '\.(mp4|ogg|json|zip)$' | while read file; do
            git add "$file"
            if [ $((batch_num % 1000)) -eq 0 ]; then
              if ! git diff --staged --quiet; then
                git commit -m "Update Assets: remaining files batch $((batch_num/1000)) - version ${{ needs.setup.outputs.version }}"
              fi
            fi
            ((batch_num++))
          done
          
          if ! git diff --staged --quiet; then
            git commit -m "Update Assets: final batch of remaining files - version ${{ needs.setup.outputs.version }}"
          fi
          
          git push origin

      - name: Cleanup
        run: |
          rm -rf artifacts

  media-run:
    runs-on: ubuntu-latest
    needs: [setup, table, media, final-commit]
    if: ${{ github.event.client_payload.run_media == true }}
    steps:
      - name: Trigger workflow with Media enabled
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "run-deployment","client_payload": {"unpack_flatdata": false,"downloads_media": true}}'

      - name: Deploy Extract
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "Extract"}'
