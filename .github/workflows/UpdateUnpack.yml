name: Unpack-Update Table

on:
  workflow_dispatch:
    inputs:
      servers:
        description: 'Select servers'
        required: true
        type: multiple choice
        options:
          - JP
          - GL
          - CN
        default: ['JP']
      db_key:
        description: 'Database decryption key (for JP server)'
        required: false
        type: string
        default: ''
  repository_dispatch:
    types: [run-deployment]
  schedule:
    - cron: '0 */1 * * *'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-outputs.outputs.matrix }}
      versions: ${{ steps.set-outputs.outputs.versions }}
      flatdata-versions: ${{ steps.set-outputs.outputs.flatdata-versions }}
      run-flags: ${{ steps.set-outputs.outputs.run-flags }}
      setup-flatdata-flags: ${{ steps.set-outputs.outputs.setup-flatdata-flags }}
    steps:
      - name: Checkout BA-Unpack repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python environment
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine servers
        id: determine-servers
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVERS_RAW='${{ toJSON(inputs.servers) }}'
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SERVERS_RAW='${{ toJSON(github.event.client_payload.servers) || '["JP"]' }}'
          else
            SERVERS_RAW='["JP"]'
          fi
          echo "SERVERS_RAW=$SERVERS_RAW" >> $GITHUB_OUTPUT

      - name: Get version information
        id: get-versions
        run: |
          SERVERS_RAW='${{ steps.determine-servers.outputs.SERVERS_RAW }}'
          SERVERS=$(echo "$SERVERS_RAW" | tr -d '[]" ')
          IFS=',' read -ra SERVER_ARRAY <<< "$SERVERS"
          
          VERSIONS="{}"
          FLATDATA_VERSIONS="{}"
          
          for SERVER in "${SERVER_ARRAY[@]}"; do
            VERSION=$(bash version.sh "$SERVER" info.json | grep BA_VERSION_NAME | cut -d= -f2)
            FLATDATA_VERSION=$(bash version.sh "$SERVER" info.json | grep FLATDATA_VERSION_NAME | cut -d= -f2)
            
            VERSIONS=$(echo "$VERSIONS" | jq --arg server "$SERVER" --arg version "$VERSION" '. + {($server): $version}')
            FLATDATA_VERSIONS=$(echo "$FLATDATA_VERSIONS" | jq --arg server "$SERVER" --arg version "$FLATDATA_VERSION" '. + {($server): $version}')
          done
          
          echo "VERSIONS=$VERSIONS" >> $GITHUB_OUTPUT
          echo "FLATDATA_VERSIONS=$FLATDATA_VERSIONS" >> $GITHUB_OUTPUT

      - name: Check existing files
        id: check-files
        run: |
          SERVERS_RAW='${{ steps.determine-servers.outputs.SERVERS_RAW }}'
          SERVERS=$(echo "$SERVERS_RAW" | tr -d '[]" ')
          IFS=',' read -ra SERVER_ARRAY <<< "$SERVERS"
          
          VERSIONS='${{ steps.get-versions.outputs.VERSIONS }}'
          FLATDATA_VERSIONS='${{ steps.get-versions.outputs.FLATDATA_VERSIONS }}'
          
          RUN_FLAGS="{}"
          SETUP_FLATDATA_FLAGS="{}"
          
          for SERVER in "${SERVER_ARRAY[@]}"; do
            SERVER_VERSION=$(echo "$VERSIONS" | jq -r --arg server "$SERVER" '.[$server]')
            SERVER_FLATDATA_VERSION=$(echo "$FLATDATA_VERSIONS" | jq -r --arg server "$SERVER" '.[$server]')
            
            git clone --depth 1 --branch "$SERVER" https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git flatdata-check-$SERVER || true
            
            if [ -f "flatdata-check-${SERVER}/${SERVER}${SERVER_FLATDATA_VERSION}.zip" ]; then
              FLATDATA_EXISTS="true"
            else
              FLATDATA_EXISTS="false"
            fi
            rm -rf "flatdata-check-${SERVER}"
            
            if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "repository_dispatch" ]; then
              RUN_FLAGS=$(echo "$RUN_FLAGS" | jq --arg server "$SERVER" '. + {($server): "true"}')
              SETUP_FLATDATA_FLAGS=$(echo "$SETUP_FLATDATA_FLAGS" | jq --arg server "$SERVER" --arg flag "$FLATDATA_EXISTS" '. + {($server): $flag}')
            else
              git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Text.git ba-text-check
              if [ -f "ba-text-check/${SERVER}${SERVER_VERSION}.zip" ]; then
                RUN_FLAGS=$(echo "$RUN_FLAGS" | jq --arg server "$SERVER" '. + {($server): "false"}')
                SETUP_FLATDATA_FLAGS=$(echo "$SETUP_FLATDATA_FLAGS" | jq --arg server "$SERVER" --arg flag "true" '. + {($server): $flag}')
              else
                RUN_FLAGS=$(echo "$RUN_FLAGS" | jq --arg server "$SERVER" '. + {($server): "true"}')
                SETUP_FLATDATA_FLAGS=$(echo "$SETUP_FLATDATA_FLAGS" | jq --arg server "$SERVER" --arg flag "$FLATDATA_EXISTS" '. + {($server): $flag}')
              fi
              rm -rf ba-text-check
            fi
          done
          
          echo "RUN_FLAGS=$RUN_FLAGS" >> $GITHUB_OUTPUT
          echo "SETUP_FLATDATA_FLAGS=$SETUP_FLATDATA_FLAGS" >> $GITHUB_OUTPUT

      - name: Set final outputs
        id: set-outputs
        run: |
          echo "matrix=${{ steps.determine-servers.outputs.SERVERS_RAW }}" >> $GITHUB_OUTPUT
          echo "versions=${{ steps.get-versions.outputs.VERSIONS }}" >> $GITHUB_OUTPUT
          echo "flatdata-versions=${{ steps.get-versions.outputs.FLATDATA_VERSIONS }}" >> $GITHUB_OUTPUT
          echo "run-flags=${{ steps.check-files.outputs.RUN_FLAGS }}" >> $GITHUB_OUTPUT
          echo "setup-flatdata-flags=${{ steps.check-files.outputs.SETUP_FLATDATA_FLAGS }}" >> $GITHUB_OUTPUT

  Table:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        server: ${{ fromJSON(needs.setup.outputs.matrix) }}
    if: |
      (github.event_name == 'schedule' && fromJSON(needs.setup.outputs.run-flags)[matrix.server] == 'true') ||
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'repository_dispatch'
    env:
      SERVER: ${{ matrix.server }}
      BA_VERSION_NAME: ${{ fromJSON(needs.setup.outputs.versions)[matrix.server] }}
      FLATDATA_VERSION_NAME: ${{ fromJSON(needs.setup.outputs.flatdata-versions)[matrix.server] }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Clone BA-FlatData
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git

      - name: Check for existing FlatData zip
        id: check-flatdata-zip
        run: |
          if [ -f "BA-FlatData/${SERVER}${BA_VERSION_NAME}.zip" ]; then
            echo "Using existing FlatData zip file"
            echo "zip-exists=true" >> $GITHUB_OUTPUT
          else
            echo "FlatData zip file not found, will generate new one"
            echo "zip-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup FlatData conditionally
        if: fromJSON(needs.setup.outputs.setup-flatdata-flags)[matrix.server] == 'false' && steps.check-flatdata-zip.outputs.zip-exists == 'false'
        run: |
          if [ "$SERVER" = "CN" ]; then
            git clone --depth 1 --branch "CN" https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git flatdata-cn
            if [ -f "flatdata-cn/dump.cs" ]; then
              mkdir -p Dumps
              cp flatdata-cn/dump.cs Dumps/
              echo "Copied dump.cs from CN branch to Dumps directory"
            fi
            rm -rf flatdata-cn
          fi
          python setup_flatdata.py $SERVER

      - name: Downloads Table files and run MemoryPackRepacker
        run: |
          chmod +x update/update_table.sh
          ./update/update_table.sh $SERVER

      - name: Create temporary directory for unpacked files
        run: |
          mkdir -p temp_unpacked

      - name: Decrypt database for JP server
        if: matrix.server == 'JP'
        run: |
          DB_FILE="./downloads/TableBundles/ExcelDB.db"
          if [ -f "$DB_FILE" ]; then
            if [ -n "${{ inputs.db_key }}" ]; then
              KEY="${{ inputs.db_key }}"
            else
              KEY="${{ secrets.DB_DECRYPT_KEY }}"
            fi
            
            echo "PRAGMA key = \"x'$KEY'\";" > decrypt_commands.txt
            echo "BEGIN TRANSACTION;" >> decrypt_commands.txt
            echo "SELECT sqlcipher_export('main');" >> decrypt_commands.txt
            echo "COMMIT;" >> decrypt_commands.txt
            echo ".quit" >> decrypt_commands.txt
            
            sqlcipher "$DB_FILE" < decrypt_commands.txt
            echo "Database decrypted successfully"
          else
            echo "Database file not found: $DB_FILE"
          fi

      - name: Unpack ExcelDB.db and Excel.zip to temporary directory
        run: |
          python unpack_excel.py ./downloads/TableBundles/ExcelDB.db ./downloads/TableBundles/Excel.zip ./unpacked ./temp_unpacked/FlatData config.json temp_text $SERVER

      - name: Prepare FlatData zip conditionally
        if: fromJSON(needs.setup.outputs.setup-flatdata-flags)[matrix.server] == 'false' && steps.check-flatdata-zip.outputs.zip-exists == 'false'
        run: |
          mkdir -p temp_flatdata_output
          cd ./temp_unpacked/FlatData/
          zip -j "../../temp_flatdata_output/${SERVER}${BA_VERSION_NAME}.zip" *
          cd

      - name: Check for existing Text zip
        id: check-text-zip
        run: |
          if [ -f "${SERVER}${BA_VERSION_NAME}.zip" ]; then
            echo "Using existing Text zip file"
            echo "text-zip-exists=true" >> $GITHUB_OUTPUT
          else
            echo "Text zip file not found, will generate new one"
            echo "text-zip-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Text zip conditionally
        if: steps.check-text-zip.outputs.text-zip-exists == 'false'
        run: |
          mkdir -p temp_text_output
          
          if [ -d "temp_unpacked/FlatData/ExcelTable" ]; then
            cp -r temp_unpacked/FlatData/ExcelTable temp_text_output/
          fi
          
          cd temp_text_output
          zip -r "../temp_flatdata_output/${SERVER}${BA_VERSION_NAME}.zip" *
          cd

      - name: Check for existing Catalog zip
        id: check-catalog-zip
        run: |
          if [ -f "${SERVER}Catalog${BA_VERSION_NAME}.zip" ]; then
            echo "Using existing Catalog zip file"
            echo "catalog-zip-exists=true" >> $GITHUB_OUTPUT
          else
            echo "Catalog zip file not found, will generate new one"
            echo "catalog-zip-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Catalog zip conditionally
        if: steps.check-catalog-zip.outputs.catalog-zip-exists == 'false'
        run: |
          if [ -f "TableCatalog.json" ] && [ -f "MediaCatalog.json" ] && [ -f "BundlePackingInfo-iOS.json" ] && [ -f "BundlePackingInfo-Android.json" ]; then
            mkdir -p temp_flatdata_output
            zip "temp_flatdata_output/${SERVER}Catalog${BA_VERSION_NAME}.zip" TableCatalog.json MediaCatalog.json BundlePackingInfo-iOS.json BundlePackingInfo-Android.json
          fi

      - name: Upload Table artifacts
        uses: actions/upload-artifact@v4
        with:
          name: table-changes-${{ matrix.server }}
          path: |
            temp_flatdata_output/
          retention-days: 1
        continue-on-error: true

  Commit:
    runs-on: ubuntu-latest
    needs: [setup, Table]
    if: always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped')) && ((github.event_name == 'schedule' && fromJSON(needs.setup.outputs.run-flags)[matrix.server] == 'true') || github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repositories
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Text.git
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git

      - name: Download all artifacts
        run: |
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          SERVERS=$(echo "$SERVERS_RAW" | tr -d '[]" ')
          IFS=',' read -ra SERVER_ARRAY <<< "$SERVERS"
          
          for SERVER in "${SERVER_ARRAY[@]}"; do
            if [ "${{ github.event_name }}" == 'schedule' ] && [ "${{ fromJSON(needs.setup.outputs.run-flags)[SERVER] }}" == 'false' ]; then
              continue
            fi
            
            echo "Downloading artifacts for server: $SERVER"
            mkdir -p artifacts/$SERVER
            gh run download --repo $GITHUB_REPOSITORY --name table-changes-$SERVER --dir artifacts/$SERVER || echo "No artifacts found for $SERVER"
          done

      - name: Process and merge artifacts
        run: |
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          SERVERS=$(echo "$SERVERS_RAW" | tr -d '[]" ')
          IFS=',' read -ra SERVER_ARRAY <<< "$SERVERS"
          VERSIONS='${{ needs.setup.outputs.versions }}'
          FLATDATA_VERSIONS='${{ needs.setup.outputs.flatdata-versions }}'
          SETUP_FLATDATA_FLAGS='${{ needs.setup.outputs.setup-flatdata-flags }}'
          
          FLATDATA_HAS_CHANGES=false
          TEXT_HAS_CHANGES=false
          
          for SERVER in "${SERVER_ARRAY[@]}"; do
            if [ "${{ github.event_name }}" == 'schedule' ] && [ "$(echo "$SETUP_FLATDATA_FLAGS" | jq -r --arg server "$SERVER" '.[$server]')" == 'false' ]; then
              continue
            fi
            
            SERVER_VERSION=$(echo "$VERSIONS" | jq -r --arg server "$SERVER" '.[$server]')
            SERVER_FLATDATA_VERSION=$(echo "$FLATDATA_VERSIONS" | jq -r --arg server "$SERVER" '.[$server]')
            NEED_SETUP_FLATDATA=$(echo "$SETUP_FLATDATA_FLAGS" | jq -r --arg server "$SERVER" '.[$server]')
            
            echo "Processing server: $SERVER, Version: $SERVER_VERSION"
            
            if [ -d "artifacts/$SERVER/temp_flatdata_output" ]; then
              echo "Found artifacts for $SERVER"
              
              if [ "$NEED_SETUP_FLATDATA" = "false" ]; then
                if [ -f "artifacts/$SERVER/temp_flatdata_output/${SERVER}${SERVER_VERSION}.zip" ]; then
                  echo "Copying FlatData zip to BA-FlatData"
                  cp "artifacts/$SERVER/temp_flatdata_output/${SERVER}${SERVER_VERSION}.zip" "BA-FlatData/"
                  FLATDATA_HAS_CHANGES=true
                fi
              fi
              
              if [ -f "artifacts/$SERVER/temp_flatdata_output/${SERVER}${SERVER_VERSION}.zip" ]; then
                echo "Found Text zip file for $SERVER"
                cp "artifacts/$SERVER/temp_flatdata_output/${SERVER}${SERVER_VERSION}.zip" "BA-Text/"
                TEXT_HAS_CHANGES=true
              fi
              
              if [ -f "artifacts/$SERVER/temp_flatdata_output/${SERVER}Catalog${SERVER_VERSION}.zip" ]; then
                echo "Found Catalog zip file for $SERVER"
                cp "artifacts/$SERVER/temp_flatdata_output/${SERVER}Catalog${SERVER_VERSION}.zip" "BA-Text/"
                TEXT_HAS_CHANGES=true
              fi
            fi
          done
          
          echo "FLATDATA_HAS_CHANGES=$FLATDATA_HAS_CHANGES" >> $GITHUB_ENV
          echo "TEXT_HAS_CHANGES=$TEXT_HAS_CHANGES" >> $GITHUB_ENV

      - name: Configure git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Commit to BA-Text
        if: env.TEXT_HAS_CHANGES == 'true'
        run: |
          cd BA-Text
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          SERVERS=$(echo "$SERVERS_RAW" | tr -d '[]" ')
          IFS=',' read -ra SERVER_ARRAY <<< "$SERVERS"
          VERSIONS='${{ needs.setup.outputs.versions }}'
          
          for SERVER in "${SERVER_ARRAY[@]}"; do
            if [ "${{ github.event_name }}" == 'schedule' ] && [ "${{ fromJSON(needs.setup.outputs.run-flags)[SERVER] }}" == 'false' ]; then
              continue
            fi
            
            SERVER_VERSION=$(echo "$VERSIONS" | jq -r --arg server "$SERVER" '.[$server]')
            
            if git show-ref --quiet refs/heads/$SERVER; then
              git checkout $SERVER
            else
              git checkout -b $SERVER
            fi
            
            git add .
            if ! git diff --staged --quiet; then
              git commit -m "Update $SERVER Text files - version $SERVER_VERSION"
              git push origin $SERVER
              echo "BA-Text $SERVER branch committed"
            else
              echo "BA-Text $SERVER branch no changes to commit"
            fi
          done
          cd ..

      - name: Commit to BA-FlatData
        if: env.FLATDATA_HAS_CHANGES == 'true'
        run: |
          cd BA-FlatData
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          SERVERS=$(echo "$SERVERS_RAW" | tr -d '[]" ')
          IFS=',' read -ra SERVER_ARRAY <<< "$SERVERS"
          VERSIONS='${{ needs.setup.outputs.versions }}'
          SETUP_FLATDATA_FLAGS='${{ needs.setup.outputs.setup-flatdata-flags }}'
          
          for SERVER in "${SERVER_ARRAY[@]}"; do
            if [ "${{ github.event_name }}" == 'schedule' ] && [ "$(echo "$SETUP_FLATDATA_FLAGS" | jq -r --arg server "$SERVER" '.[$server]')" == 'false' ]; then
              continue
            fi
            
            SERVER_VERSION=$(echo "$VERSIONS" | jq -r --arg server "$SERVER" '.[$server]')
            
            if git show-ref --quiet refs/heads/$SERVER; then
              git checkout $SERVER
            else
              git checkout -b $SERVER
            fi
            
            git add .
            if ! git diff --staged --quiet; then
              git commit -m "Update $SERVER FlatData - version $SERVER_VERSION"
              git push origin $SERVER
              echo "BA-FlatData $SERVER branch committed"
            else
              echo "BA-FlatData $SERVER branch no changes to commit"
            fi
          done
          cd ..

      - name: Cleanup
        run: |
          rm -rf artifacts
