name: Update-Unpack Excel

on:
  workflow_dispatch:
    inputs:
      JP_Enabled: { type: boolean, default: false }
      GL_Enabled: { type: boolean, default: false }
      CN_Enabled: { type: boolean, default: false }
  repository_dispatch:
    types: [run-deployment]

permissions:
  contents: write

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      db_key: ${{ steps.detect.outputs.db_key }}
      jp_sw: ${{ steps.detect.outputs.jp }}
      gl_sw: ${{ steps.detect.outputs.gl }}
      cn_sw: ${{ steps.detect.outputs.cn }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clone Translation Tool
        run: git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool
          
      - name: Detect Trigger Source and Inputs
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "jp=${{ github.event.client_payload.JP_enabled || 'false' }}" >> $GITHUB_OUTPUT
            echo "gl=${{ github.event.client_payload.GL_enabled || 'false' }}" >> $GITHUB_OUTPUT
            echo "cn=${{ github.event.client_payload.CN_enabled || 'false' }}" >> $GITHUB_OUTPUT
          else
            echo "jp=${{ inputs.JP_Enabled }}" >> $GITHUB_OUTPUT
            echo "gl=${{ inputs.GL_Enabled }}" >> $GITHUB_OUTPUT
            echo "cn=${{ inputs.CN_Enabled }}" >> $GITHUB_OUTPUT
          fi
          echo "db_key=${{ secrets.DB_DECRYPT_KEY }}" >> $GITHUB_OUTPUT

      - name: Generate Strategy Matrix
        id: set-matrix
        run: |
          MATRIX=$(jq -nc \
            --arg jp "${{ steps.detect.outputs.jp }}" \
            --arg gl "${{ steps.detect.outputs.gl }}" \
            --arg cn "${{ steps.detect.outputs.cn }}" \
            '[
              {id: "JP", name: "日服", enabled: $jp},
              {id: "GL", name: "国际服", enabled: $gl},
              {id: "CN", name: "国服", enabled: $cn}
            ] | map(select(.enabled == "true"))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  process:
    name: Process ${{ matrix.server.name }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: 
        server: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Tool Environment
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts


      - name: Verify Remote Version Status
        id: check
        run: |
          if [[ "${{ github.event_name }}" =~ (workflow|repository)_dispatch ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            git clone --depth 1 --branch ${{ matrix.server.id }} git@github.com:roundRekt/BA-Assets-TableBundles.git check
            [ -f "check/${{ matrix.server.name }}${{ steps.v.outputs.ver }}.zip" ] && echo "run=false" >> $GITHUB_OUTPUT || echo "run=true" >> $GITHUB_OUTPUT
          fi

      - name: Install System Libraries
        if: steps.check.outputs.run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev

      - name: Install Python Packages
        if: steps.check.outputs.run == 'true'
        run: pip install pysqlcipher3 sqlcipher3 -r requirements.txt

      - name: Clone Data Repositories
        if: steps.check.outputs.run == 'true'
        run: |
          git clone --depth 1 --branch ${{ matrix.server.id }} https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git BA-FlatData
          git clone --depth 1 --branch ${{ matrix.server.id }} git@github.com:roundRekt/BA-Assets-TableBundles.git BA-Text
          [ "${{ matrix.server.id }}" = "CN" ] && mkdir -p Dumps && cp BA-FlatData/dump.cs Dumps/ || true

      - name: Run Setup FlatData
        if: steps.check.outputs.run == 'true'
        run: python setup_flatdata.py ${{ matrix.server.id }}

      - name: Run Update Table Script
        if: steps.check.outputs.run == 'true'
        run: |
          chmod +x update/update_table.sh
          update/update_table.sh ${{ matrix.server.id }}

      - name: Run Unpack Excel Script
        if: steps.check.outputs.run == 'true'
        run: python unpack_excel.py ./downloads/TableBundles/ExcelDB.db ./downloads/TableBundles/Excel.zip ./Extracted/FlatData ./other/config.json ./unpacked ${{ matrix.server.id }} --db_key "${{ needs.setup.outputs.db_key }}"

      - name: Organize Raw Data for Artifacts
        if: steps.check.outputs.run == 'true' && success()
        run: |
          mkdir -p workspace/bundle_raw workspace/flatdata_raw
          cp -r unpacked/* workspace/bundle_raw/
          cp -r Extracted/FlatData/* workspace/flatdata_raw/

      - name: Store Temporary Artifacts
        if: steps.check.outputs.run == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: table-${{ matrix.server.id }}
          path: workspace/

  Final:
    name: Final Commit
    needs: [setup, process]
    runs-on: ubuntu-latest
    if: always() && needs.setup.outputs.matrix != '[]' && !contains(needs.process.result, 'cancelled')
    env:
      GH_TOKEN: ${{ secrets.APK_SRC_REPO }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Git Identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Prepare Translation Tool
        run: git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool

      - name: Download Processed Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: table-*
          merge-multiple: false

      - name: Get Version
        id: get_ver
        run: |
          for s in JP GL CN; do
            if [ -d "all-artifacts/table-$s" ]; then
              eval $(bash tool/other/version.sh "$s" info.json)
              echo "${s}_BA_VERSION_NAME=$BA_VERSION_NAME" >> $GITHUB_OUTPUT
              echo "${s}_FLATDATA_VERSION_NAME=$FLATDATA_VERSION_NAME" >> $GITHUB_OUTPUT
            fi
          done

      - name: Package and Push Changes
        run: |
          for s in JP GL CN; do
            if [ -d "all-artifacts/table-$s" ]; then
              case $s in
                JP) 
                  NAME="日服"
                  VER_NAME="${{ steps.get_ver.outputs.JP_BA_VERSION_NAME }}"
                  FD_NAME="${{ steps.get_ver.outputs.JP_FLATDATA_VERSION_NAME }}"
                  ;;
                GL) 
                  NAME="国际服"
                  VER_NAME="${{ steps.get_ver.outputs.GL_BA_VERSION_NAME }}"
                  FD_NAME="${{ steps.get_ver.outputs.GL_FLATDATA_VERSION_NAME }}"
                  ;;
                CN) 
                  NAME="国服"
                  VER_NAME="${{ steps.get_ver.outputs.CN_BA_VERSION_NAME }}"
                  FD_NAME="${{ steps.get_ver.outputs.CN_FLATDATA_VERSION_NAME }}"
                  ;;
              esac

              git clone --depth 1 --branch $s git@github.com:roundRekt/BA-Assets-TableBundles.git "txt-$s"
              cd "all-artifacts/table-$s/bundle_raw"
              zip -r "../../../txt-$s/${NAME}${VER_NAME}.zip" DBSchema ExcelTable
              cd ../../../
              cd "txt-$s"
              git add .
              git diff --staged --quiet || (git commit -m "Update $NAME Text Assets ${VER_NAME}" && git push origin $s)
              cd ..
              
              git clone --depth 1 --branch $s https://x-access-token:${GH_TOKEN}@github.com/beichen23333/BA-FlatData.git "fd-$s"
              cd "all-artifacts/table-$s/flatdata_raw"
              zip -j "../../../fd-$s/${NAME}${FD_NAME}.zip" *
              cd ../../../
              cd "fd-$s"
              git add .
              git diff --staged --quiet || (git commit -m "Update $NAME FlatData Zip ${FD_NAME}" && git push origin $s)
              cd ..
            fi
          done
