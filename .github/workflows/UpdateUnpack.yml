name: Update-Unpack Excel

on:
  workflow_dispatch:
    inputs:
      JP_Enabled: { type: boolean, default: false }
      GL_Enabled: { type: boolean, default: false }
      CN_Enabled: { type: boolean, default: false }
  repository_dispatch:
    types: [Unpack]

permissions:
  contents: write

jobs:
  setup:
    name: 设置配置
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Detect Trigger Source
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "jp=${{ github.event.client_payload.JP_enabled || 'false' }}" >> $GITHUB_OUTPUT
            echo "gl=${{ github.event.client_payload.GL_enabled || 'false' }}" >> $GITHUB_OUTPUT
            echo "cn=${{ github.event.client_payload.CN_enabled || 'false' }}" >> $GITHUB_OUTPUT
          else
            echo "jp=${{ inputs.JP_Enabled }}" >> $GITHUB_OUTPUT
            echo "gl=${{ inputs.GL_Enabled }}" >> $GITHUB_OUTPUT
            echo "cn=${{ inputs.CN_Enabled }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Strategy Matrix
        id: set-matrix
        run: |
          MATRIX=$(jq -nc \
            --arg jp "${{ steps.detect.outputs.jp }}" \
            --arg gl "${{ steps.detect.outputs.gl }}" \
            --arg cn "${{ steps.detect.outputs.cn }}" \
            '[
              {id: "JP", name: "日服", enabled: $jp},
              {id: "GL", name: "国际服", enabled: $gl},
              {id: "CN", name: "国服", enabled: $cn}
            ] | map(select(.enabled == "true"))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  process:
    name: 处理${{ matrix.server.name }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: 
        server: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare Tool Environment
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Get Version info
        id: v
        run: |
          SERVER_ID_LOWER=$(echo "${{ matrix.server.id }}" | tr '[:upper:]' '[:lower:]')
          bash other/version.sh ${{ matrix.server.id }} info_${SERVER_ID_LOWER}.json >> "$GITHUB_OUTPUT"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev
          pip install pysqlcipher3 sqlcipher3 -r requirements.txt

      - name: Cache FlatData
        id: cache-flatdata
        uses: actions/cache@v4
        with:
          path: Extracted/FlatData
          key: ${{ matrix.server.id }}-flatdata-${{ steps.v.outputs.FLATDATA_VERSION_NAME }}

      - name: Clone Text Repository
        run: |
          git clone --depth 1 --branch ${{ matrix.server.id }} git@github.com:roundRekt/BA-Assets-TableBundles.git BA-Text

      - name: Execute Unpack Scripts
        run: |
          chmod +x update/update_table.sh
          update/update_table.sh ${{ matrix.server.id }}
          python unpack_excel.py ./TableBundles/ExcelDB.db ./TableBundles/Excel.zip ./Extracted/FlatData ./unpacked ${{ matrix.server.id }}

      - name: Organize Artifacts
        run: |
          mkdir -p workspace/bundle_raw
          cp -r unpacked/* workspace/bundle_raw/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: table-${{ matrix.server.id }}
          path: workspace/

  Final:
    name: 提交文件
    needs: [setup, process]
    runs-on: ubuntu-latest
    if: always() && needs.setup.outputs.matrix != '[]' && !contains(needs.process.result, 'cancelled')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Git Identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Prepare Translation Tool
        run: git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool

      - name: Download Processed Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: table-*
          merge-multiple: false

      - name: Package and Push
        run: |
          mkdir -p final-packages
          for s in JP GL CN; do
            if [ -d "all-artifacts/table-$s" ]; then
              SERVER_ID_LOWER=$(echo "$s" | tr '[:upper:]' '[:lower:]')
              bash tool/other/version.sh "$s" "info_${SERVER_ID_LOWER}.json"
              V_BA=$(grep "${s}_BA_VERSION_NAME" "$GITHUB_OUTPUT" | cut -d'=' -f2)
              case $s in
                JP) NAME="日服" ;;
                GL) NAME="国际服" ;;
                CN) NAME="国服" ;;
              esac
              
              cd "all-artifacts/table-$s/bundle_raw"
              FILE_NAME="${NAME}${V_BA}.zip"
              zip -r "../../../final-packages/$FILE_NAME" DBSchema ExcelTable
              cd ../../../

              git clone --depth 1 --branch $s git@github.com:roundRekt/BA-Assets-TableBundles.git "repo-$s"
              cp "final-packages/$FILE_NAME" "repo-$s/"
              cd "repo-$s"
              git add .
              git diff --staged --quiet || (git commit -m "Update $NAME $V_BA" && git push origin $s)
              cd ..
            fi
          done

      - name: Trigger Extract Dispatch
        if: github.event_name == 'repository_dispatch' && success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: Extract
          client-payload: '{"JP_enabled": "${{ github.event.client_payload.JP_enabled }}", "GL_enabled": "${{ github.event.client_payload.GL_enabled }}", "CN_enabled": "${{ github.event.client_payload.CN_enabled }}"}'
