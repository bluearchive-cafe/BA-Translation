name: Update Unpack
on:
  workflow_dispatch:
    inputs:
      Unpack_FlatData:
        description: 'Unpack FlatData?'
        required: false
        type: boolean
        default: true
      Downloads_Meida:
        description: 'Downloads Media?'
        required: false
        type: boolean
        default: false
      Extract_Bundle:
        description: 'Extract Bundle?'
        required: false
        type: boolean
        default: false
  repository_dispatch:
    types: [run-deployment]
permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-versions.outputs.BA_VERSION_NAME }}
      trigger-type: ${{ steps.detect-trigger.outputs.trigger-type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Detect trigger type
        id: detect-trigger
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "trigger-type=repository_dispatch" >> $GITHUB_OUTPUT
          else
            echo "trigger-type=workflow_dispatch" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: get-versions
        run: bash version.sh info.json >> "$GITHUB_OUTPUT"

      - name: Get version name
        run: |
          echo "BA_VERSION_NAME=${{ steps.get-versions.outputs.BA_VERSION_NAME }}" >> $GITHUB_ENV

  bundle-setup:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ inputs.Extract_Bundle }}
    outputs:
      bundle-packs: ${{ steps.get-bundle-packs.outputs.bundle-packs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get Bundle packs list
        id: get-bundle-packs
        env:
          DEFAULT_BUNDLE_PACKS: ${{ secrets.DEFAULT_BUNDLE_PACKS || 'FullPatch_100.zip,FullPatch_101.zip|FullPatch_102.zip,FullPatch_103.zip|FullPatch_104.zip,FullPatch_105.zip|FullPatch_106.zip,FullPatch_107.zip|FullPatch_108.zip,FullPatch_109.zip|FullPatch_110.zip,FullPatch_111.zip|FullPatch_112.zip,FullPatch_113.zip|FullPatch_114.zip,FullPatch_115.zip' }}
        run: |
          chmod +x update.sh
          ./update.sh JP Bundle 1 catalog-only
          python get_bundle_packs.py >> "$GITHUB_OUTPUT"

  bundle-group-1:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 1
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP1_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f1)
          echo "Processing bundle group 1: $GROUP1_PACKS"
          if [ -n "$GROUP1_PACKS" ] && [ "$GROUP1_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP1_PACKS"
          else
            echo "No packs in group 1, skipping"
          fi

      - name: Upload Bundle artifacts group 1
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-1
          path: BA-Assets/
          retention-days: 1

  bundle-group-2:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 2
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP2_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f2)
          echo "Processing bundle group 2: $GROUP2_PACKS"
          if [ -n "$GROUP2_PACKS" ] && [ "$GROUP2_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP2_PACKS"
          else
            echo "No packs in group 2, skipping"
          fi

      - name: Upload Bundle artifacts group 2
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-2
          path: BA-Assets/
          retention-days: 1

  bundle-group-3:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 3
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP3_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f3)
          echo "Processing bundle group 3: $GROUP3_PACKS"
          if [ -n "$GROUP3_PACKS" ] && [ "$GROUP3_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP3_PACKS"
          else
            echo "No packs in group 3, skipping"
          fi

      - name: Upload Bundle artifacts group 3
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-3
          path: BA-Assets/
          retention-days: 1

  bundle-group-4:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 4
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP4_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f4)
          echo "Processing bundle group 4: $GROUP4_PACKS"
          if [ -n "$GROUP4_PACKS" ] && [ "$GROUP4_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP4_PACKS"
          else
            echo "No packs in group 4, skipping"
          fi

      - name: Upload Bundle artifacts group 4
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-4
          path: BA-Assets/
          retention-days: 1

  bundle-group-5:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 5
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP5_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f5)
          echo "Processing bundle group 5: $GROUP5_PACKS"
          if [ -n "$GROUP5_PACKS" ] && [ "$GROUP5_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP5_PACKS"
          else
            echo "No packs in group 5, skipping"
          fi

      - name: Upload Bundle artifacts group 5
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-5
          path: BA-Assets/
          retention-days: 1

  bundle-group-6:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 6
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP6_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f6)
          echo "Processing bundle group 6: $GROUP6_PACKS"
          if [ -n "$GROUP6_PACKS" ] && [ "$GROUP6_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP6_PACKS"
          else
            echo "No packs in group 6, skipping"
          fi

      - name: Upload Bundle artifacts group 6
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-6
          path: BA-Assets/
          retention-days: 1

  bundle-group-7:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 7
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP7_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f7)
          echo "Processing bundle group 7: $GROUP7_PACKS"
          if [ -n "$GROUP7_PACKS" ] && [ "$GROUP7_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP7_PACKS"
          else
            echo "No packs in group 7, skipping"
          fi

      - name: Upload Bundle artifacts group 7
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-7
          path: BA-Assets/
          retention-days: 1

  bundle-group-8:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    if: ${{ inputs.Extract_Bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Extract bundle group 8
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP8_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f8)
          echo "Processing bundle group 8: $GROUP8_PACKS"
          if [ -n "$GROUP8_PACKS" ] && [ "$GROUP8_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP8_PACKS"
          else
            echo "No packs in group 8, skipping"
          fi

      - name: Upload Bundle artifacts group 8
        uses: actions/upload-artifact@v4
        with:
          name: bundle-changes-group-8
          path: BA-Assets/
          retention-days: 1

  Table:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ inputs.Unpack_FlatData || github.event_name == 'repository_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone BA-FlatData
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git

      - name: Clone BA-Text
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Text.git

      - name: Setup FlatData
        run: |
          python setup_flatdata.py

      - name: Downloads Table files and run MemoryPackRepacker
        run: |
          chmod +x update.sh
          ./update.sh JP Table

      - name: Unpack ExcelDB.db and Excel.zip
        run: |
          python unpack_excel.py ./downloads/TableBundles/ExcelDB.db ./downloads/TableBundles/Excel.zip ./unpacked ./Extracted/FlatData config.json BA-Text 10

      - name: Prepare FlatData
        run: |
          cd ./Extracted/FlatData/
          zip -j "FlatData${BA_VERSION_NAME}.zip" *
          mv "FlatData${BA_VERSION_NAME}.zip" ../../BA-FlatData/
          cd

      - name: Prepare Text files
        run: |
          cp {TableCatalog.json,MediaCatalog.json,BundlePackingInfo-iOS.json,BundlePackingInfo-Android.json} BA-Text
          cd BA-Text
          zip -r "./日服${BA_VERSION_NAME}.zip" DBSchema ExcelTable
          cd

      - name: Prepare Assets files
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git
          FILES=("TableCatalog.json" "MediaCatalog.json" "BundlePackingInfo-iOS.json" "BundlePackingInfo-Android.json")

          for file in "${FILES[@]}"; do
            if [ -f "BA-Assets/$file" ]; then
              echo "删除已存在的文件: BA-Assets/$file"
              rm "BA-Assets/$file"
            fi
          done

          cp {TableCatalog.json,MediaCatalog.json,BundlePackingInfo-iOS.json,BundlePackingInfo-Android.json} "BA-Assets"
          if [ -d "BA-Assets/DBSchema" ]; then
            rm -rf "BA-Assets/DBSchema"
          fi
          mv "BA-Text/DBSchema" "BA-Assets/DBSchema"
          if [ -d "BA-Assets/ExcelTable" ]; then
            rm -rf "BA-Assets/ExcelTable"
          fi
          mv "BA-Text/ExcelTable" "BA-Assets/ExcelTable"

          cd BA-Assets

          for item in DBSchema ExcelTable TableCatalog.json MediaCatalog.json BundlePackingInfo-iOS.json BundlePackingInfo-Android.json; do
              if [ -e "$item" ]; then
                  if [ -d "$item" ]; then
                      echo "Processing directory: $item"
                      find "$item" -type f | while read -r file; do
                          file_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
                          if [ "$file_size" -gt 104857600 ]; then
                              echo "[$file] >100 MB ($((file_size/1048576)) MB), compressing to $file.gz"
                              gzip -c "$file" > "$file.gz"
                              rm "$file"
                          fi
                      done
                  else
                      file_size=$(stat -c%s "$item" 2>/dev/null || stat -f%z "$item")
                      if [ "$file_size" -gt 104857600 ]; then
                          echo "[$item] >100 MB ($((file_size/1048576)) MB), compressing to $item.gz"
                          gzip -c "$item" > "$item.gz"
                          rm "$item"
                      fi
                  fi
              fi
          done

      - name: Upload Table artifacts
        uses: actions/upload-artifact@v4
        with:
          name: table-changes
          path: |
            BA-FlatData/
            BA-Text/
            BA-Assets/
          retention-days: 1

  Media:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ inputs.Downloads_Meida }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Clone Assets repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Downloads Media files
        run: |
          chmod +x update.sh
          ./update.sh JP Media 8

      - name: Upload Media artifacts
        uses: actions/upload-artifact@v4
        with:
          name: media-changes
          path: BA-Assets/
          retention-days: 1

  final-commit:
    runs-on: ubuntu-latest
    needs: [Table, Media, bundle-group-1, bundle-group-2, bundle-group-3, bundle-group-4, bundle-group-5, bundle-group-6, bundle-group-7, bundle-group-8]
    if: always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped'))
    steps:
      - name: Clone repositories
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Text.git
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Assets.git

      - name: Download Table artifacts
        if: needs.Table.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: table-changes
          path: artifacts/table-changes
          retry-count: 5
          retry-delay: 30000

      - name: Download Media artifacts
        if: needs.Media.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: media-changes
          path: artifacts/media-changes
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 1
        if: needs.bundle-group-1.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-1
          path: artifacts/bundle-changes-group-1
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 2
        if: needs.bundle-group-2.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-2
          path: artifacts/bundle-changes-group-2
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 3
        if: needs.bundle-group-3.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-3
          path: artifacts/bundle-changes-group-3
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 4
        if: needs.bundle-group-4.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-4
          path: artifacts/bundle-changes-group-4
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 5
        if: needs.bundle-group-5.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-5
          path: artifacts/bundle-changes-group-5
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 6
        if: needs.bundle-group-6.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-6
          path: artifacts/bundle-changes-group-6
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 7
        if: needs.bundle-group-7.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-7
          path: artifacts/bundle-changes-group-7
          retry-count: 5
          retry-delay: 30000

      - name: Download Bundle artifacts group 8
        if: needs.bundle-group-8.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: bundle-changes-group-8
          path: artifacts/bundle-changes-group-8
          retry-count: 5
          retry-delay: 30000

      - name: Apply changes from artifacts
        run: |
          echo "Applying changes from artifacts..."
          
          # 创建必要的目录结构
          mkdir -p artifacts/table-changes artifacts/media-changes \
                   artifacts/bundle-changes-group-1 artifacts/bundle-changes-group-2 \
                   artifacts/bundle-changes-group-3 artifacts/bundle-changes-group-4 \
                   artifacts/bundle-changes-group-5 artifacts/bundle-changes-group-6 \
                   artifacts/bundle-changes-group-7 artifacts/bundle-changes-group-8
          
          if [ -d "artifacts/table-changes" ] && [ "$(ls -A artifacts/table-changes 2>/dev/null)" ]; then
            echo "Applying table changes..."
            if [ -d "artifacts/table-changes/BA-FlatData" ]; then
              rsync -av artifacts/table-changes/BA-FlatData/ BA-FlatData/ || true
            fi
            if [ -d "artifacts/table-changes/BA-Text" ]; then
              rsync -av artifacts/table-changes/BA-Text/ BA-Text/ || true
            fi
            if [ -d "artifacts/table-changes/BA-Assets" ]; then
              rsync -av artifacts/table-changes/BA-Assets/ BA-Assets/ || true
            fi
          else
            echo "No table changes to apply"
          fi
          
          if [ -d "artifacts/media-changes" ] && [ "$(ls -A artifacts/media-changes 2>/dev/null)" ]; then
            echo "Applying media changes..."
            rsync -av artifacts/media-changes/ BA-Assets/ || true
          else
            echo "No media changes to apply"
          fi
          
          for group in 1 2 3 4 5 6 7 8; do
            if [ -d "artifacts/bundle-changes-group-$group" ] && [ "$(ls -A artifacts/bundle-changes-group-$group 2>/dev/null)" ]; then
              echo "Applying bundle changes from group $group..."
              rsync -av artifacts/bundle-changes-group-$group/ BA-Assets/ || true
            else
              echo "No bundle changes from group $group to apply"
            fi
          done
          
          echo "All changes applied successfully"

      - name: Configure git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Commit to BA-FlatData
        run: |
          cd BA-FlatData
          git add .
          if git diff --staged --quiet; then
            echo "No changes in BA-FlatData"
          else
            git commit -m "Update FlatData version ${{ needs.setup.outputs.version }}" && git push origin
          fi

      - name: Commit to BA-Text
        run: |
          cd BA-Text
          git add .
          if git diff --staged --quiet; then
            echo "No changes in BA-Text"
          else
            git commit -m "Update Text version ${{ needs.setup.outputs.version }}" && git push origin
          fi

      - name: Smart commit to BA-Assets
        run: |
          cd BA-Assets
          
          smart_commit() {
            local file_type=$1
            local pattern=$2
            local commit_msg=$3
            local batch_size=200
            local batch_num=1
            
            echo "Processing $file_type files..."
            
            # 检查是否有匹配的文件
            if ! find . -name "$pattern" -type f | grep -q .; then
              echo "No $file_type files found, skipping..."
              return 0
            fi
            
            local file_count=0
            local current_batch=()
            
            # 使用 while read 安全处理文件名
            while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                current_batch+=("$file")
                ((file_count++))
                
                # 达到批量大小时提交
                if [ ${#current_batch[@]} -ge $batch_size ]; then
                  echo "Adding ${#current_batch[@]} $file_type files (batch $batch_num)"
                  
                  # 安全地添加文件
                  for file_path in "${current_batch[@]}"; do
                    git add -- "$file_path"
                  done
                  
                  # 检查是否有变更需要提交
                  if ! git diff --staged --quiet; then
                    if git commit -m "$commit_msg (batch $batch_num)"; then
                      echo "✓ Committed batch $batch_num"
                      # 尝试推送，如果失败则回退
                      if git push origin; then
                        echo "✓ Pushed batch $batch_num"
                      else
                        echo "✗ Failed to push batch $batch_num, resetting..."
                        git reset --hard HEAD~1
                        # 将文件重新加入暂存区，等待后续处理
                        for file_path in "${current_batch[@]}"; do
                          git add -- "$file_path"
                        done
                      fi
                    else
                      echo "✗ Failed to commit batch $batch_num"
                      git reset
                    fi
                  else
                    echo "No changes to commit in batch $batch_num"
                    current_batch=()
                  fi
                  
                  batch_num=$((batch_num + 1))
                  current_batch=()
                fi
              fi
            done < <(find . -name "$pattern" -type f -print0 2>/dev/null)
            
            # 处理剩余文件
            if [ ${#current_batch[@]} -gt 0 ]; then
              echo "Adding final batch of ${#current_batch[@]} $file_type files"
              
              for file_path in "${current_batch[@]}"; do
                git add -- "$file_path"
              done
              
              if ! git diff --staged --quiet; then
                if git commit -m "$commit_msg (final batch)"; then
                  echo "✓ Committed final batch"
                  if git push origin; then
                    echo "✓ Pushed final batch"
                  else
                    echo "✗ Failed to push final batch"
                    git reset --hard HEAD~1
                  fi
                else
                  echo "✗ Failed to commit final batch"
                  git reset
                fi
              else
                echo "No changes to commit in final batch"
              fi
            fi
            
            echo "Completed processing $file_count $file_type files"
          }
          
          # 按文件类型顺序处理
          echo "Starting smart commit process..."
          
          # 先检查是否有任何变更
          if git diff --cached --quiet && git diff --quiet; then
            echo "No changes detected in BA-Assets, skipping commit process"
            cd ..
            exit 0
          fi
          
          # 先处理小文件，最后处理大文件
          smart_commit "json" "*.json" "Update Assets: json files - version ${{ needs.setup.outputs.version }}"
          smart_commit "zip" "*.zip" "Update Assets: zip files - version ${{ needs.setup.outputs.version }}"
          smart_commit "png" "*.png" "Update Assets: png files - version ${{ needs.setup.outputs.version }}"
          smart_commit "jpg" "*.jpg" "Update Assets: jpg files - version ${{ needs.setup.outputs.version }}"
          smart_commit "ogg" "*.ogg" "Update Assets: ogg files - version ${{ needs.setup.outputs.version }}"
          smart_commit "mp4" "*.mp4" "Update Assets: mp4 files - version ${{ needs.setup.outputs.version }}"
          
          # 处理其他文件类型
          echo "Processing other file types..."
          other_files=()
          while IFS= read -r -d '' file; do
            other_files+=("$file")
          done < <(find . -type f ! -name "*.json" ! -name "*.zip" ! -name "*.png" ! -name "*.jpg" ! -name "*.ogg" ! -name "*.mp4" -print0 2>/dev/null)
          
          if [ ${#other_files[@]} -gt 0 ]; then
            echo "Found ${#other_files[@]} other files"
            
            batch_num=1
            current_batch=()
            
            for file_path in "${other_files[@]}"; do
              current_batch+=("$file_path")
              
              if [ ${#current_batch[@]} -ge 200 ]; then
                for f in "${current_batch[@]}"; do
                  git add -- "$f"
                done
                
                if ! git diff --staged --quiet; then
                  if git commit -m "Update Assets: other files batch $batch_num - version ${{ needs.setup.outputs.version }}"; then
                    if git push origin; then
                      echo "✓ Pushed other files batch $batch_num"
                    else
                      echo "✗ Failed to push other files batch $batch_num"
                      git reset --hard HEAD~1
                    fi
                  fi
                else
                  echo "No changes to commit in other files batch $batch_num"
                fi
                
                batch_num=$((batch_num + 1))
                current_batch=()
              fi
            done
            
            # 处理最后一批
            if [ ${#current_batch[@]} -gt 0 ]; then
              for f in "${current_batch[@]}"; do
                git add -- "$f"
              done
              
              if ! git diff --staged --quiet; then
                git commit -m "Update Assets: final other files - version ${{ needs.setup.outputs.version }}"
                git push origin
              else
                echo "No changes to commit in final other files batch"
              fi
            fi
          else
            echo "No other files found"
          fi
          
          echo "Smart commit process completed"

      - name: Cleanup
        run: |
          rm -rf artifacts BA-FlatData BA-Text BA-Assets

  media-bundle-run:
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload.run_media_bundle == true }}
    steps:
      - name: Trigger workflow with Media and Bundle enabled
        run: |
          curl -X POST \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml/dispatches \
          -d '{"ref": "${{ github.ref }}", "inputs": {"Unpack_FlatData": false, "Downloads_Meida": true, "Extract_Bundle": true}}'

      - name: Deploy Translation
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "Extract"}'
