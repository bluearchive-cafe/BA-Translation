name: Unpack-Update Bundle

on:
  workflow_dispatch:
    inputs:
  repository_dispatch:
    types: [run-deployment-bundle]

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-versions.outputs.BA_VERSION_NAME }}
      extract-bundle: ${{ steps.detect-params.outputs.extract-bundle }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version
        id: get-versions
        run: bash version.sh info.json >> "$GITHUB_OUTPUT"

      - name: Get version name
        run: |
          echo "BA_VERSION_NAME=${{ steps.get-versions.outputs.BA_VERSION_NAME }}" >> $GITHUB_ENV

  bundle-setup:
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      bundle-packs: ${{ steps.get-bundle-packs.outputs.bundle-packs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get Bundle packs list
        id: get-bundle-packs
        env:
          DEFAULT_BUNDLE_PACKS: ${{ secrets.DEFAULT_BUNDLE_PACKS || 'FullPatch_100.zip,FullPatch_101.zip,FullPatch_102.zip,FullPatch_103.zip|FullPatch_104.zip,FullPatch_105.zip,FullPatch_106.zip,FullPatch_107.zip|FullPatch_108.zip,FullPatch_109.zip,FullPatch_110.zip,FullPatch_111.zip|FullPatch_112.zip,FullPatch_113.zip,FullPatch_114.zip,FullPatch_115.zip' }}
        run: |
          chmod +x update.sh
          ./update.sh JP Bundle 1 catalog-only
          python get_bundle_packs.py >> "$GITHUB_OUTPUT"

  bundle-group-1:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Extract bundle group 1
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP1_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f1)
          if [ -n "$GROUP1_PACKS" ] && [ "$GROUP1_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP1_PACKS"
          fi

      - name: Create bundle zip package
        run: |
          if [ -d "./bundle_output" ] && [ "$(ls -A ./bundle_output 2>/dev/null)" ]; then
            cd ./bundle_output
            zip -r "../bundle_extracted_content_group1.zip" .
            cd
          else
            touch empty_bundle_group1.zip
          fi

      - name: Upload Bundle zip artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-zip-group-1
          path: |
            bundle_extracted_content_group1.zip
            empty_bundle_group1.zip
          retention-days: 1

  bundle-group-2:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Extract bundle group 2
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP2_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f2)
          if [ -n "$GROUP2_PACKS" ] && [ "$GROUP2_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP2_PACKS"
          fi

      - name: Create bundle zip package
        run: |
          if [ -d "./bundle_output" ] && [ "$(ls -A ./bundle_output 2>/dev/null)" ]; then
            cd ./bundle_output
            zip -r "../bundle_extracted_content_group2.zip" .
            cd
          else
            touch empty_bundle_group2.zip
          fi

      - name: Upload Bundle zip artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-zip-group-2
          path: |
            bundle_extracted_content_group2.zip
            empty_bundle_group2.zip
          retention-days: 1

  bundle-group-3:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Extract bundle group 3
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP3_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f3)
          if [ -n "$GROUP3_PACKS" ] && [ "$GROUP3_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP3_PACKS"
          fi

      - name: Create bundle zip package
        run: |
          if [ -d "./bundle_output" ] && [ "$(ls -A ./bundle_output 2>/dev/null)" ]; then
            cd ./bundle_output
            zip -r "../bundle_extracted_content_group3.zip" .
            cd
          else
            touch empty_bundle_group3.zip
          fi

      - name: Upload Bundle zip artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-zip-group-3
          path: |
            bundle_extracted_content_group3.zip
            empty_bundle_group3.zip
          retention-days: 1

  bundle-group-4:
    runs-on: ubuntu-latest
    needs: [setup, bundle-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Get version from setup job
        run: |
          echo "BA_VERSION_NAME=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Extract bundle group 4
        run: |
          chmod +x update.sh
          ALL_PACKS="${{ needs.bundle-setup.outputs.bundle-packs }}"
          GROUP4_PACKS=$(echo "$ALL_PACKS" | cut -d'|' -f4)
          if [ -n "$GROUP4_PACKS" ] && [ "$GROUP4_PACKS" != "" ]; then
            ./update.sh JP Bundle 8 "$GROUP4_PACKS"
          fi

      - name: Create bundle zip package
        run: |
          if [ -d "./bundle_output" ] && [ "$(ls -A ./bundle_output 2>/dev/null)" ]; then
            cd ./bundle_output
            zip -r "../bundle_extracted_content_group4.zip" .
            cd
          else
            touch empty_bundle_group4.zip
          fi

      - name: Upload Bundle zip artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bundle-zip-group-4
          path: |
            bundle_extracted_content_group4.zip
            empty_bundle_group4.zip
          retention-days: 1
