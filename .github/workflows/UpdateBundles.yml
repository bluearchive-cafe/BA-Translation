name: Update Bundles

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Bundles]

permissions:
  contents: write

jobs:
  generate-config:
    runs-on: ubuntu-latest
    outputs:
      has-cache: ${{ steps.check-cache.outputs.has-cache }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone Required Repositories
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        run: pip install UnityPy Pillow requests

      - name: Setup Repacker Permissions
        run: chmod +x ./other/MemoryPackRepacker

      - name: Generate Bundle Config
        run: python update_bundles_config.py

      - name: Check Cache Directory
        id: check-cache
        run: |
          if [ -d cache_zips ] && [ "$(find cache_zips -type f -name '*.zip' | wc -l)" -gt 0 ]; then
            echo "has-cache=true" >> $GITHUB_OUTPUT
          else
            echo "has-cache=false" >> $GITHUB_OUTPUT
          fi

      - name: Save Cache
        if: steps.check-cache.outputs.has-cache == 'true'
        uses: actions/cache/save@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - name: Commit and Push Config Changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add bundle_config_*.json || true
          git commit -m "Update bundle config" || true
          git push origin main || true

  repack-bundles:
    runs-on: ubuntu-latest
    needs: generate-config
    if: needs.generate-config.outputs.has-cache == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - name: Clone Repositories and Install Dependencies
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-AssetsBundles.git BA-AssetsBundles
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-AssetsBundles-zip.git BA-AssetsBundles-zip
          cp -r tool/* .
          pip install -r requirements.txt

      - name: Setup Repacker Permissions
        run: chmod +x ./other/MemoryPackRepacker

      - name: Run Repack Bundles Script
        run: python repack_bundles.py

      - name: Archive Release Assets
        run: |
          mkdir -p release_assets
          zip -r release_assets/output_zips.zip output_zips
          zip -r release_assets/Android_PatchPack.zip Android_PatchPack
          zip -r release_assets/iOS_PatchPack.zip iOS_PatchPack

      - name: Update Asset Bundles Repository (Git LFS)
        run: |
          cd BA-AssetsBundles
          git lfs install
          git lfs track "*.bundle"
          git lfs track "*.zip"
          git add .gitattributes
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git commit -m "Update with LFS and max compression" || true
          git push origin main

          cd ../BA-AssetsBundles-zip
          git add .
          git diff --cached --quiet || (git commit -m "Update bundle zips" && git push)

          cd
          git add BundlePackingInfo_*.json PatchPack/**/catalog_*.zip
          git diff --cached --quiet || (git commit -m "Update BundlePackingInfo and catalog" && git push)

  extract-spine:
    runs-on: ubuntu-latest
    needs: generate-config
    if: needs.generate-config.outputs.has-cache == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - name: Clone Repositories and Install Dependencies
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/spinecharacters.git
          git clone --depth 1 git@github.com:bluearchive-cafe/spinelobbies.git
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .
          pip install -r requirements.txt

      - name: Run Extract Bundles Script
        run: python extract_bundles.py

      - name: Commit and Push Extracted Spine Assets
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          rm -rf spine_output
          mkdir -p spine_output

          for repo in spinecharacters spinelobbies; do
            cd $repo
            git add .
            if [ -n "$(git status --porcelain)" ]; then
              new_dirs=$(git status --porcelain | awk '/^A/ {print $2}' | cut -d/ -f1 | sort -u)
              git commit -m "Add new spine assets"
              git push origin main
              for d in $new_dirs; do
                mkdir -p "../spine_output/$repo"
                cp -r "$d" "../spine_output/$repo/"
              done
            fi
            cd ..
          done

      - name: Upload Extracted Spine Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spine-extracted
          path: |
            spine_output
            extract_result.json

  convert-spine:
    runs-on: ubuntu-latest
    needs: extract-spine
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Download Spine Artifacts
        uses: actions/download-artifact@v4
        with:
          name: spine-extracted
          path: .

      - name: Clone Target Repositories
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-SpineCharacters.git
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-SpineLobbies.git
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - name: Setup .NET environment
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build SpineConverter
        run: |
          git clone --depth 1 -b 4.2 https://github.com/EsotericSoftware/spine-runtimes.git
          mkdir -p SpineConverter/spine-csharp
          cp -r spine-runtimes/spine-csharp/src/* SpineConverter/spine-csharp/
          dotnet build SpineConverter/SpineConverter.csproj -c Release

      - name: Install System Dependencies and SpineViewerCLI
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb ffmpeg libfontconfig1 libicu-dev \
            libsfml-graphics2.6 libsfml-window2.6 libsfml-system2.6 \
            libgl1-mesa-dev libxcursor1 libxinerama1 libxi6 libxrandr2
          curl -L -o tool.zip https://github.com/ww-rm/SpineViewer/releases/download/v0.16.13/SpineViewerCLI-v0.16.13-Linux-SelfContained.zip
          unzip tool.zip
          chmod +x SpineViewerCLI*/SpineViewerCLI

      - name: Run Extract Spine Assets Script
        run: python extract_spine_assets.py

      - name: Convert Spine Assets (Sequential processing)
        run: |
          Xvfb :99 -screen 0 1024x768x24 &
          export DISPLAY=:99
          sleep 3
          TOOL=$(find . -name SpineViewerCLI | head -n1)

          echo "Starting character processing..."
          jq -r '.[] | select(contains("spinecharacters"))' extract_result.json | while read role; do
            base="spine_output/$role"
            [ ! -d "$base" ] && continue
            filename=$(basename "$role")
            temp_src="src_char_${filename}"
            temp_out="out_char_${filename}"
            mkdir -p "$temp_src" "$temp_out"
            cp "$base/TextAsset/"* "$temp_src/" 2>/dev/null || true
            cp "$base/Texture2D/"* "$temp_src/" 2>/dev/null || true
            skel=$(ls "$temp_src"/*.skel 2>/dev/null | head -n1)
            if [ -n "$skel" ]; then
              RAW=$(dotnet run --project SpineConverter -- "$skel" 2>/dev/null || true)
              echo "$RAW" | sed -n '/ANIM_DATA_START/,/ANIM_DATA_END/p' | grep -v ANIM_DATA_ | cut -d'|' -f1 | while read anim; do
                [ -z "$anim" ] && continue
                $TOOL export "$skel" --format Png --animations "$anim" --output "$temp_out/$anim.png" --quiet 2>/dev/null || true
              done
              if [ "$(find "$temp_out" -type f -name '*.png' | wc -l)" -gt 0 ]; then
                (cd "$temp_out" && zip -j "../BA-SpineCharacters/${filename}.zip" *.png)
              fi
            fi
            rm -rf "$temp_src" "$temp_out"
          done

          echo "Starting lobby processing (1 min loop)..."
          jq -r '.[] | select(contains("spinelobbies"))' extract_result.json | while read role; do
            base="spine_output/$role"
            [ ! -d "$base" ] && continue
            filename=$(basename "$role")
            temp_src="src_lobby_${filename}"
            mkdir -p "$temp_src"
            cp "$base/TextAsset/"* "$temp_src/" 2>/dev/null || true
            cp "$base/Texture2D/"* "$temp_src/" 2>/dev/null || true
            skel=$(ls "$temp_src"/*.skel 2>/dev/null | head -n1)
            
            if [ -n "$skel" ]; then
              $TOOL export "$skel" --format Mp4 --animations "Idle_01" --output "temp_raw.mp4" --quiet 2>/dev/null || true
              
              if [ -f "temp_raw.mp4" ]; then
                duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 temp_raw.mp4)
                loop_count=$(awk -v dur="$duration" 'BEGIN {print int(60/dur) + 1}')
                ffmpeg -y -stream_loop "$loop_count" -i temp_raw.mp4 -t 60 -c copy "BA-SpineLobbies/${filename}.mp4" -quiet 2>/dev/null || true
                rm temp_raw.mp4
              fi
            fi
            rm -rf "$temp_src"
          done

      - name: Commit and Push Converted Assets
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          cd BA-SpineCharacters
          git add .
          git commit -m "Update characters" || true
          git push origin main
          cd ..

          cd BA-SpineLobbies
          git add .
          git commit -m "Update lobbies (60s loop)" || true
          git push origin main
