name: Update Bundles

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Bundles]

permissions:
  contents: write

jobs:
  generate-config:
    runs-on: ubuntu-latest
    outputs:
      has-cache: ${{ steps.check-cache.outputs.has-cache }}
    steps:
      - uses: actions/checkout@v4

      - name: SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone Repos
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install UnityPy Pillow requests
      - run: chmod +x ./other/MemoryPackRepacker

      - name: Generate Config & Download Changed Zips
        run: python update_bundles_config.py

      - id: check-cache
        run: |
          if [ -d cache_zips ] && [ "$(find cache_zips -type f -name '*.zip' | wc -l)" -gt 0 ]; then
            echo "has-cache=true" >> $GITHUB_OUTPUT
          else
            echo "has-cache=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/cache/save@v4
        if: steps.check-cache.outputs.has-cache == 'true'
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - name: Commit Config
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add bundle_config_*.json || true
          git commit -m "Update bundle config" || true
          git push origin main || true


  repack-bundles:
    runs-on: ubuntu-latest
    needs: generate-config
    if: needs.generate-config.outputs.has-cache == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone Repos
        run: |
          git clone git@github.com:bluearchive-cafe/BA-AssetsBundles.git BA-AssetsBundles
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install UnityPy Pillow

      - uses: actions/cache/restore@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - name: Repack Bundles
        run: python repack_bundles.py

      - name: Commit Asset Bundles Cache
        run: |
          cd BA-AssetsBundles
          git add .
          git commit -m "Update processed bundles" || true
          git push origin main || true

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: run-${{ github.run_id }}
          name: Bundles ${{ github.run_id }}
          files: |
            output_zips/Android/*.zip

  extract-spine:
    runs-on: ubuntu-latest
    needs: generate-config
    if: needs.generate-config.outputs.has-cache == 'true'
    outputs:
      roles: ${{ steps.extract.outputs.roles }}
    steps:
      - uses: actions/checkout@v4

      - name: SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install UnityPy Pillow

      - uses: actions/cache/restore@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - name: Clone Spine Repos
        run: |
          git clone git@github.com:bluearchive-cafe/spinecharacters.git
          git clone git@github.com:bluearchive-cafe/spinelobbies.git
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - id: extract
        run: python extract_bundles.py

      - name: Commit New Spine Characters
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          for repo in spinecharacters spinelobbies; do
            cd $repo
            if [ -n "$(git status --porcelain)" ]; then
              git add .
              git commit -m "Add new spine characters"
              git push origin main
            fi
            cd ..
          done


  convert-spine:
    runs-on: ubuntu-latest
    needs: extract-spine
    if: needs.extract-spine.outputs.roles != '[]'
    steps:
      - uses: actions/checkout@v4

      - name: SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone Tool Repo
        run: |
          git clone git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build SpineConverter
        run: dotnet build SpineConverter/SpineConverter.csproj -c Release

      - name: Install Runtime Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb ffmpeg libfontconfig1 libicu-dev \
            libsfml-graphics2.6 libsfml-window2.6 libsfml-system2.6 \
            libgl1-mesa-dev libxcursor1 libxinerama1 libxi6 libxrandr2

      - name: Setup SpineViewerCLI
        run: |
          curl -L -o tool.zip https://github.com/ww-rm/SpineViewer/releases/download/v0.16.13/SpineViewerCLI-v0.16.13-Linux-SelfContained.zip
          unzip tool.zip
          chmod +x SpineViewerCLI-v0.16.13-Linux-SelfContained/SpineViewerCLI

      - name: Prepare Spine Jobs
        run: python extract_spine_assets.py

      - name: Convert Spine to PNG
        run: |
          Xvfb :99 -screen 0 1024x768x24 &
          export DISPLAY=:99
          sleep 2

          TOOL=./SpineViewerCLI-v0.16.13-Linux-SelfContained/SpineViewerCLI

          jq -r 'keys[]' spine_jobs.json | while read role; do
            skel=$(jq -r ".\"$role\".skel" spine_jobs.json)
            out="output/$role"
            mkdir -p "$out"

            RAW=$(dotnet run --project SpineConverter -- "$skel")
            echo "$RAW" | sed -n '/ANIM_DATA_START/,/ANIM_DATA_END/p' | \
              grep -v ANIM_DATA_ | cut -d'|' -f1 | while read anim; do
                $TOOL export "$skel" \
                  --format Png \
                  --animations "$anim" \
                  --output "$out/${anim}.png" \
                  --quiet || true
              done

            (cd output && zip -r "${role}.zip" "$role")
          done

      - name: Commit Spine Output
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add output/*.zip || true
          git commit -m "Add spine animation zips" || true
          git push origin main || true