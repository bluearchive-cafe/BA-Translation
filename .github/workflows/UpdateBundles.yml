name: Update Bundles
on:
  workflow_dispatch:
  repository_dispatch:
    types: [Bundles]
permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: "[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]"
    steps:
      - run: echo "准备中..."

  download_and_process:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        platform: [Android, iOS]
        segment: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone Tool Repository
        run: |
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool

      - name: Clone BA-Image Repository (For Comparison)
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install requirements
        run: |
          pip install -r requirements.txt

      - run: |
          chmod +x ./other/MemoryPackRepacker
          # 传入 --repo 参数指定 BA-Image 仓库路径用于读取旧数据
          python update_bundles.py --platform ${{ matrix.platform }} --segment ${{ matrix.segment }} --total 15 --repo ./ba_image_repo

      - uses: actions/upload-artifact@v4
        with:
          name: assets-${{ matrix.platform }}-${{ matrix.segment }}
          path: |
            output_assets/
            configs/

  merge_and_push:
    needs: download_and_process
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Configure SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - uses: actions/download-artifact@v4
        with:
          path: merged_artifacts

      - name: Sync and Push Assets
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # 合并 bundle_config
          python -c "
          import json, glob, os
          for p in ['android', 'ios']:
              full = {}
              # 查找 artifacts 中所有的 config 文件
              files = glob.glob(f'merged_artifacts/assets-*/configs/bundle_config_{p}.json')
              for f in files:
                  with open(f) as j:
                      d = json.load(j)
                      if d: full.update(d)
              if full:
                  with open(f'bundle_config_{p}.json', 'w') as out:
                      json.dump(full, out, indent=4)
          "
          
          # 1. 提交主仓库的 config 更新
          git add bundle_config_*.json
          git commit -m "Update Assets Config" || echo "No config changes"
          git push origin main

          # 2. 提交角色立绘 (Spine Characters)
          git clone git@github.com:bluearchive-cafe/spinecharacters.git repo_chars
          cp -r merged_artifacts/assets-*/output_assets/spinecharacters/* repo_chars/ 2>/dev/null || true
          cd repo_chars
          git add .
          git commit -m "Update Spine Characters" || echo "No character changes"
          git push origin 角色立绘
          cd ..

          # 3. 提交记忆大厅 (Spine Lobbies)
          git clone git@github.com:bluearchive-cafe/spinelobbies.git repo_lobbies
          cp -r merged_artifacts/assets-*/output_assets/spinelobbies/* repo_lobbies/ 2>/dev/null || true
          cd repo_lobbies
          git add .
          git commit -m "Update Spine Lobbies" || echo "No lobby changes"
          git push origin 记忆大厅
          cd ..
          
          # 4. 提交 BA-Image (BundlePackingInfo)
          # 注意：虽然我们在 matrix 中并行运行，但每个 segment 生成的 BundlePackingInfo 是相同的（因为是基于同一个服务器目录生成的）
          # 所以直接覆盖即可
          git clone git@github.com:bluearchive-cafe/BA-Image.git repo_ba_image
          cp merged_artifacts/assets-*/configs/BundlePackingInfo_*.json repo_ba_image/ 2>/dev/null || true
          cd repo_ba_image
          git add BundlePackingInfo_*.json
          git commit -m "Update BundlePackingInfo" || echo "No packing info changes"
          git push origin main
          cd ..

          rm -rf merged_artifacts repo_chars repo_lobbies repo_ba_image
