name: Update Bundles

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Bundles]

permissions:
  contents: write

jobs:
  generate-config:
    runs-on: ubuntu-latest
    outputs:
      cache-key: run-${{ github.run_id }}
    steps:
      - uses: actions/checkout@v4

      - run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install UnityPy Pillow requests

      - run: python update_bundles_config.py

      - uses: actions/cache/save@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add bundle_config_*.json
          git commit -m "Update bundle config" || true
          git push origin main || true

          git clone git@github.com:bluearchive-cafe/BA-Image.git ba_img
          cp output/BundlePackingInfo_*.json ba_img/ 2>/dev/null || true
          cd ba_img
          git add .
          git commit -m "Update BundlePackingInfo" || true
          git push origin main || true

  repack-bundles:
    runs-on: ubuntu-latest
    needs: generate-config
    steps:
      - uses: actions/checkout@v4

      - run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install UnityPy Pillow

      - uses: actions/cache/restore@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - run: python repack_bundles.py

  extract-textures:
    runs-on: ubuntu-latest
    needs: generate-config
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - run: pip install UnityPy

      - uses: actions/cache/restore@v4
        with:
          path: cache_zips
          key: run-${{ github.run_id }}

      - run: python extract_bundles.py

      - uses: actions/cache/delete@v4
        with:
          key: run-${{ github.run_id }}