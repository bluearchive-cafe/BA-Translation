name: Update Bundles & Spine

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Bundles]

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: "[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]"
    steps:
      - run: echo "Start"

  download_and_modify:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [Android, iOS]
        segment: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]
    steps:
      - uses: actions/checkout@v4
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh && echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - name: Clone Tools & Image Repo
        run: |
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* .
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install
        run: pip install -r requirements.txt UnityPy Pillow requests
      - name: Run
        run: |
          chmod +x ./other/MemoryPackRepacker
          python update_bundles.py --platform ${{ matrix.platform }} --segment ${{ matrix.segment }} --total 15 --repo ./ba_image_repo
      - uses: actions/upload-artifact@v4
        with:
          name: part-${{ matrix.platform }}-${{ matrix.segment }}
          path: |
            configs/
            modified_bundles_only/
            spine_raw/
          if-no-files-found: ignore

  process_results:
    needs: download_and_modify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh && echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - uses: actions/download-artifact@v4
        with:
          path: all_parts
      
      - name: Create Merged Bundle Zip
        run: |
          mkdir -p final_out
          # 将所有分段中修改过的 .bundle 移动到一个地方
          find all_parts -name "modified_bundles_only" -type d | xargs -I {} cp -rn {}/. final_out/ 2>/dev/null || true
          cd final_out
          zip -j ../PatchedBundles.zip ./*.bundle || echo "No bundles to zip"
          cd ..
      
      - name: Upload Single Zip
        uses: actions/upload-artifact@v4
        with:
          name: Patched-Bundles-All
          path: PatchedBundles.zip

      - name: Update Config Repos
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          python -c "
          import json, glob, os
          for p in ['android', 'ios']:
              full = {}
              for f in glob.glob(f'all_parts/part-{p.capitalize()}-*/configs/bundle_config_{p}.json'):
                  with open(f) as j: full.update(json.load(j))
              if full:
                  with open(f'bundle_config_{p}.json', 'w') as out: json.dump(full, out, indent=4)
          "
          git add bundle_config_*.json && git commit -m "Update Config" && git push origin main || true

          git clone git@github.com:bluearchive-cafe/BA-Image.git ba_img
          cp all_parts/part-*/configs/BundlePackingInfo_*.json ba_img/ 2>/dev/null || true
          cd ba_img && git add . && git commit -m "Update Info" && git push origin main || true

  convert_spine:
    needs: download_and_modify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deps
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb ffmpeg libsfml-graphics2.6 libsfml-window2.6 libsfml-system2.6
          curl -L -o tool.zip https://github.com/ww-rm/SpineViewer/releases/download/v0.16.13/SpineViewerCLI-v0.16.13-Linux-SelfContained.zip
          unzip tool.zip && chmod +x SpineViewerCLI-v0.16.13-Linux-SelfContained/SpineViewerCLI
      - uses: actions/download-artifact@v4
        with:
          path: all_parts

      - name: Build SpineConverter
        run: |
          git clone --depth 1 -b 4.2 https://github.com/EsotericSoftware/spine-runtimes.git
          mkdir -p SpineConverter/spine-csharp
          cp -r spine-runtimes/spine-csharp/src/* SpineConverter/spine-csharp/
          cat <<EOF > SpineConverter/SpineConverter.csproj
          <Project Sdk="Microsoft.NET.Sdk"><PropertyGroup><OutputType>Exe</OutputType><TargetFramework>net8.0</TargetFramework></PropertyGroup></Project>
          EOF
          cat <<EOF > SpineConverter/Program.cs
          using System;using System.IO;using Spine;
          namespace SpineConverter { class Program { static void Main(string[] args) {
            try { var loader = new DeploymentAttachmentLoader(); var binary = new SkeletonBinary(loader);
            using (var stream = new FileStream(args[0], FileMode.Open)) { var data = binary.ReadSkeletonData(stream);
            Console.WriteLine("ANIM_DATA_START"); foreach (var anim in data.Animations) Console.WriteLine(anim.Name + "|" + anim.Duration); Console.WriteLine("ANIM_DATA_END"); }
            } catch { Environment.Exit(1); } } }
            public class DeploymentAttachmentLoader : AttachmentLoader {
              public RegionAttachment NewRegionAttachment(Skin s, string n, string p, Sequence q) => new RegionAttachment(n);
              public MeshAttachment NewMeshAttachment(Skin s, string n, string p, Sequence q) => new MeshAttachment(n);
              public BoundingBoxAttachment NewBoundingBoxAttachment(Skin s, string n) => new BoundingBoxAttachment(n);
              public PathAttachment NewPathAttachment(Skin s, string n) => new PathAttachment(n);
              public PointAttachment NewPointAttachment(Skin s, string n) => new PointAttachment(n);
              public ClippingAttachment NewClippingAttachment(Skin s, string n) => new ClippingAttachment(n);
          } }
          EOF
          dotnet build SpineConverter/SpineConverter.csproj -c Release -o ./build

      - name: Process Repos
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

          git clone -b 角色立绘 git@github.com:bluearchive-cafe/spinecharacters.git repo_raw
          git clone git@github.com:bluearchive-cafe/BA-SpineCharacters.git repo_zip

          TOOL_PATH="$(pwd)/SpineViewerCLI-v0.16.13-Linux-SelfContained/SpineViewerCLI"
          CONVERTER_PATH="$(pwd)/build/SpineConverter"
          Xvfb :99 -screen 0 1024x768x24 -nolisten tcp > /dev/null 2>&1 &
          export DISPLAY=:99 && sleep 3

          # 寻找所有提取的角色目录
          find all_artifacts -type d -name "TextAsset" | while read ta_dir; do
            char_root=$(dirname "$ta_dir")
            char_name=$(basename "$char_root")
            echo "Processing $char_name..."

            # 1. 提交原始提取结构到 spinecharacters (包含 TextAsset 和 Texture2D 文件夹)
            mkdir -p "repo_raw/$char_name"
            cp -r "$char_root"/* "repo_raw/$char_name/"

            # 2. 导出动态 PNG 序列到 BA-SpineCharacters
            WORK_DIR="work_$char_name"
            mkdir -p "$WORK_DIR/out"
            skel_file=$(find "$ta_dir" -name "*.skel" | head -n 1)
            [ -z "$skel_file" ] && continue
            
            # 准备转换环境 (将 skel 和 atlas 放在同级)
            cp "$skel_file" "$WORK_DIR/$char_name.skel"
            find "$ta_dir" -name "*.atlas" -exec cp {} "$WORK_DIR/$char_name.atlas" \;
            cp "$char_root/Texture2D"/*.png "$WORK_DIR/" 2>/dev/null || true

            cd "$WORK_DIR"
            ANIM_DATA=$($CONVERTER_PATH "$char_name.skel" | sed -n '/ANIM_DATA_START/,/ANIM_DATA_END/p' | grep -v "ANIM_DATA_")
            IFS=$'\n'
            for line in $ANIM_DATA; do
              anim=$(echo "$line" | cut -d'|' -f1)
              $TOOL_PATH export "$char_name.skel" --format Png --animations "$anim" --output "out/${anim}.png" --quiet 2>/dev/null || true
            done
            cd out && zip -r "../../repo_zip/${char_name}.zip" . && cd ../..
          done

          cd repo_raw && git add . && git commit -m "Sync Raw" && git push origin 角色立绘 || true
          cd ../repo_zip && git add . && git commit -m "Sync Zips" && git push origin main || true
