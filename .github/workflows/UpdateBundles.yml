name: Update Bundles & Spine

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Bundles]

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: "[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]"
    steps:
      - run: echo "Starting..."

  download_and_modify:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [Android, iOS]
        segment: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Clone Tool Repo
        run: |
          git clone --depth 1 git@github.com:beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool

      - name: Clone BA-Image Repo (For Image Replacement)
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Image.git ba_image_repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Run Update Script
        run: |
          chmod +x ./other/MemoryPackRepacker
          # 脚本会生成 configs/, modified_packs/, spine_raw/
          python update_bundles.py --platform ${{ matrix.platform }} --segment ${{ matrix.segment }} --total 15 --repo ./ba_image_repo

      # 上传所有产物供后续步骤或合并使用
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.platform }}-${{ matrix.segment }}
          path: |
            configs/
            modified_packs/
            spine_raw/
          retention-days: 1

  process_results:
    needs: download_and_modify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: Merge Configs & Push Image Repo Info
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # 1. 合并 bundle_config
          python -c "
          import json, glob, os
          for p in ['android', 'ios']:
              full = {}
              files = glob.glob(f'all_artifacts/artifacts-*/configs/bundle_config_{p}.json')
              for f in files:
                  with open(f) as j:
                      d = json.load(j)
                      if d: full.update(d)
              if full:
                  with open(f'bundle_config_{p}.json', 'w') as out:
                      json.dump(full, out, indent=4)
          "
          
          # 更新主仓库配置
          git add bundle_config_*.json
          git commit -m "Update Assets Config" || echo "No changes"
          git push origin main

          # 2. 更新 BA-Image 的 BundlePackingInfo
          git clone git@github.com:bluearchive-cafe/BA-Image.git repo_ba_image
          cp all_artifacts/artifacts-*/configs/BundlePackingInfo_*.json repo_ba_image/ 2>/dev/null || true
          cd repo_ba_image
          git add BundlePackingInfo_*.json
          git commit -m "Update BundlePackingInfo" || echo "No info changes"
          git push origin main
          cd ..

      - name: Upload Modified Packs (Patch)
        # 这里假设你需要将修改后的 Zip 上传到某个地方，或者作为 Release
        # 你的 Prompt 说是"上传"，但没说传到哪，通常是传到 Release 或 Artifacts
        # 这里将其打包为总 Artifact
        run: |
          mkdir -p final_patch
          cp all_artifacts/artifacts-*/modified_packs/*.zip final_patch/ 2>/dev/null || true
          
      - uses: actions/upload-artifact@v4
        with:
          name: Final-Patched-Bundles
          path: final_patch/
          retention-days: 1

  convert_spine:
    needs: download_and_modify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: Prepare Spine Converter
        run: |
          # 编译 Converter
          git clone --depth 1 -b 4.2 https://github.com/EsotericSoftware/spine-runtimes.git
          mkdir -p SpineConverter/spine-csharp
          cp -r spine-runtimes/spine-csharp/src/* SpineConverter/spine-csharp/

          cat <<EOF > SpineConverter/SpineConverter.csproj
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup><OutputType>Exe</OutputType><TargetFramework>net8.0</TargetFramework></PropertyGroup>
          </Project>
          EOF

          cat <<EOF > SpineConverter/Program.cs
          using System;
          using System.IO;
          using Spine;
          namespace SpineConverter {
              class Program {
                  static void Main(string[] args) {
                      if (args.Length < 1) return;
                      try {
                          var loader = new DeploymentAttachmentLoader();
                          var binary = new SkeletonBinary(loader);
                          // 增加容错：如果找不到文件
                          if (!File.Exists(args[0])) return;
                          using (var stream = new FileStream(args[0], FileMode.Open, FileAccess.Read)) {
                              SkeletonData data = binary.ReadSkeletonData(stream);
                              Console.WriteLine("ANIM_DATA_START");
                              foreach (var anim in data.Animations) {
                                  Console.WriteLine(anim.Name + "|" + anim.Duration);
                              }
                              Console.WriteLine("ANIM_DATA_END");
                          }
                      } catch (Exception e) { Console.Error.WriteLine(e.Message); Environment.Exit(1); }
                  }
              }
              public class DeploymentAttachmentLoader : AttachmentLoader {
                  public RegionAttachment NewRegionAttachment(Skin skin, string name, string path, Sequence sequence) => new RegionAttachment(name);
                  public MeshAttachment NewMeshAttachment(Skin skin, string name, string path, Sequence sequence) => new MeshAttachment(name);
                  public BoundingBoxAttachment NewBoundingBoxAttachment(Skin skin, string name) => new BoundingBoxAttachment(name);
                  public PathAttachment NewPathAttachment(Skin skin, string name) => new PathAttachment(name);
                  public PointAttachment NewPointAttachment(Skin skin, string name) => new PointAttachment(name);
                  public ClippingAttachment NewClippingAttachment(Skin skin, string name) => new ClippingAttachment(name);
              }
          }
          EOF
          
          dotnet build SpineConverter/SpineConverter.csproj -c Release -o ./build

      - name: Install Runtime Deps and SpineViewerCLI
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb ffmpeg libfontconfig1 libicu-dev libsfml-graphics2.6 libsfml-window2.6 libsfml-system2.6 libgl1-mesa-dev libxcursor1 libxinerama1 libxi6 libxrandr2
          curl -L -o tool.zip https://github.com/ww-rm/SpineViewer/releases/download/v0.16.13/SpineViewerCLI-v0.16.13-Linux-SelfContained.zip
          unzip tool.zip
          chmod +x SpineViewerCLI-v0.16.13-Linux-SelfContained/SpineViewerCLI

      - name: Convert and Push Spine Assets
        run: |
          mkdir -p repo_chars
          
          # 克隆目标仓库
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
          git clone git@github.com:bluearchive-cafe/spinecharacters.git repo_chars

          TOOL_PATH="$(pwd)/SpineViewerCLI-v0.16.13-Linux-SelfContained/SpineViewerCLI"
          CONVERTER_PATH="$(pwd)/build/SpineConverter"
          
          # 启动 Xvfb
          Xvfb :99 -screen 0 1024x768x24 -nolisten tcp > /dev/null 2>&1 &
          export DISPLAY=:99
          sleep 3

          # 遍历所有提取出的 spine 资源
          # 路径结构: all_artifacts/artifacts-*/spine_raw/character_name/TextAsset/*.skel
          
          find all_artifacts -name "*.skel.bytes" -o -name "*.skel" | while read skel_file; do
             # 获取目录信息
             dir_path=$(dirname "$skel_file")          # .../TextAsset
             char_root=$(dirname "$dir_path")          # .../spine_raw/arona
             char_name=$(basename "$char_root")        # arona
             
             echo "Processing $char_name ..."
             
             # 准备工作目录
             WORK_DIR="work_$char_name"
             mkdir -p "$WORK_DIR"
             
             # 移动资源到工作目录 (skel, atlas, png)
             # 注意：UnityPy 提取的 .atlas 可能是 .txt 或 .bytes，需要重命名为 .atlas
             cp "$skel_file" "$WORK_DIR/$char_name.skel"
             
             # 找 atlas
             find "$char_root" -name "*.atlas*" | head -n 1 | xargs -I {} cp {} "$WORK_DIR/$char_name.atlas"
             
             # 找 texture (png)
             # UnityPy 提取在 Texture2D 文件夹
             cp "$char_root/Texture2D"/*.png "$WORK_DIR/" 2>/dev/null || true
             
             cd "$WORK_DIR"
             
             # 1. 获取动画列表
             if [ -f "$char_name.skel" ]; then
                 RAW_OUT=$($CONVERTER_PATH "$char_name.skel")
                 ANIM_DATA=$(echo "$RAW_OUT" | sed -n '/ANIM_DATA_START/,/ANIM_DATA_END/p' | grep -v "ANIM_DATA_")
                 
                 mkdir -p output_pngs
                 
                 # 2. 导出 PNG 序列
                 IFS=$'\n'
                 for line in $ANIM_DATA; do
                    anim_name=$(echo "$line" | cut -d'|' -f1)
                    if [ ! -z "$anim_name" ]; then
                        echo "  Exporting animation: $anim_name"
                        $TOOL_PATH export "$char_name.skel" --format Png --animations "$anim_name" --output "output_pngs/${anim_name}.png" --quiet 2>/dev/null || true
                    fi
                 done
                 
                 # 3. 移动到仓库目录
                 # 假设仓库结构为 character_name/animation.png
                 TARGET_DIR="../repo_chars/$char_name"
                 mkdir -p "$TARGET_DIR"
                 cp output_pngs/*.png "$TARGET_DIR/" 2>/dev/null || true
             fi
             
             cd ..
             rm -rf "$WORK_DIR"
          done

          # 提交
          cd repo_chars
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add .
          git commit -m "Update Spine Characters (Dynamic PNGs)" || echo "No changes"
          git push origin main
