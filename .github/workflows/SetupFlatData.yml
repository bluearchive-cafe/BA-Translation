name: Setup FlatData Worker

on:
  repository_dispatch:
    types: [setup_flatdata]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate Strategy Matrix
        id: set-matrix
        run: |
          MATRIX=$(jq -nc --arg jp "${{ github.event.client_payload.jp_updated_text }}" --arg gl "${{ github.event.client_payload.gl_updated }}" --arg cn "${{ github.event.client_payload.cn_updated }}" \
            '[
              {id: "JP", name: "日服", enabled: $jp},
              {id: "GL", name: "国际服", enabled: $gl},
              {id: "CN", name: "国服", enabled: $cn}
            ] | map(select(.enabled == "true"))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    if: needs.prepare.outputs.matrix != '[]' && needs.prepare.outputs.matrix != ''
    strategy:
      fail-fast: false
      matrix:
        server: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clone Tool
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BlueArchive-Translation.git tool
          cp -r tool/* . && rm -rf tool

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Process Data
        id: process
        run: |
          bash other/version.sh ${{ matrix.server.id }} info.json
          V_FL=$(grep '${{ matrix.server.id }}_FLATDATA_VERSION_NAME' $GITHUB_OUTPUT | cut -d'=' -f2)
          echo "fl_ver=$V_FL" >> $GITHUB_OUTPUT
          python setup_flatdata.py ${{ matrix.server.id }}

      - name: Package and Push
        env:
          GH_TOKEN: ${{ secrets.APK_SRC_REPO }}
        run: |
          ZIP_NAME="${{ matrix.server.name }}${{ steps.process.outputs.fl_ver }}.zip"
          cd Extracted && zip -r "../$ZIP_NAME" . && cd ..
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone --depth 1 --branch ${{ matrix.server.id }} https://x-access-token:${GH_TOKEN}@github.com/beichen23333/BA-FlatData.git repo_flat
          cp "$ZIP_NAME" repo_flat/
          cd repo_flat
          git add .
          git commit -m "Upload FlatData: $ZIP_NAME" && git push origin ${{ matrix.server.id }} || echo "No changes"

  dispatch_final:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Dispatch Tasks
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\": \"Unpack\", \"client_payload\": {\"JP_enabled\": ${{ github.event.client_payload.jp_updated_text }}, \"GL_enabled\": ${{ github.event.client_payload.gl_updated }}, \"CN_enabled\": ${{ github.event.client_payload.cn_updated }}}}"
          
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\": \"Repack\", \"client_payload\": {\"custom_dir\": \"${{ github.event.client_payload.jp_ac_ver }}\"}}"
