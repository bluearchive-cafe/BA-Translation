name: Update Text

on:
  workflow_dispatch:
  repository_dispatch:
    types: [Text]
permissions:
  contents: write
jobs:
  repository:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

      - name: Login
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Clone repositories
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BlueArchive-Translation.git BlueArchive-Translation
          git clone --depth 1 --branch JP git@github.com:bluearchive-cafe/BA-Assets-TableBundles.git BA-Assets-TableBundles

      - name: Move contents to current directory
        run: |
          mv BlueArchive-Translation/* .
          rm -rf BlueArchive-Translation

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Get new version
        id: new_ver
        run: |
          echo "Current info.json content:"
          cat info_jp.json
          echo "Running version.sh on current info.json:"
          bash other/version.sh JP info_jp.json >> "$GITHUB_OUTPUT"

      - name: Run update
        run: |
          git clone --depth 1 git@github.com:bluearchive-cafe/BA-Text-Translation.git BA-Text-Translation

          python -m tools.clean "BA-Assets-TableBundles/日服${{ steps.new_ver.outputs.BA_VERSION_NAME }}.zip" "BA-Text-Translation/日服${{ steps.new_ver.outputs.BA_VERSION_NAME }}.zip" JP
          python -m tools.update "BA-Text-Translation/日服${{ steps.new_ver.outputs.BA_VERSION_NAME }}.zip" "BA-Text-Translation/日服备份.zip" "BA-Text-Translation/日服备份.zip"
          python -m tools.back "BA-Text-Translation"
          python -m tools.re_extract "BA-Text-Translation" "BA-Text-Translation/日服备份.zip" JP

      - name: Commit files Translation
        run: |
          cd BA-Text-Translation
          if [ -d "NewBack" ]; then rm -rf "NewBack"; fi      
          if [ -d "ReviseBack" ]; then rm -rf "ReviseBack"; fi
          
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "文本写回 $(date +%F-%T)"
            git push origin
          else
            echo "No changes to commit in BA-Text-Translation"
          fi
          cd ..

      - name: Run Repack
        if: github.event_name == 'repository_dispatch'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.APK_SRC_REPO }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "Repack","client_payload": {"custom_dir": "${{ github.event.client_payload.custom_dir }}","is_cn": "false","is_dev": "false"}}'
